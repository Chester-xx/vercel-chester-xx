<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Python Video Downloader â€” Dependency Map</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600;700&family=Syne:wght@400;700;800&display=swap');

  :root {
    --bg: #0a0c10;
    --surface: #0f1115;
    --border: #1a1e28;
    --accent-cyan: #00e5ff;
    --accent-amber: #ffb300;
    --accent-rose: #ff4d6d;
    --accent-green: #00e676;
    --accent-purple: #b388ff;
    --accent-blue: #448aff;
    --accent-dim: #3a4055;
    --text: #c8cfe0;
    --text-dim: #434860;
    --node-bg: #0f1218;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'JetBrains Mono', monospace;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    overflow: hidden;
    user-select: none;
  }

  header {
    position: fixed; top: 0; left: 0; right: 0; z-index: 100;
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 24px;
    background: rgba(10,12,16,0.94);
    border-bottom: 1px solid var(--border);
    backdrop-filter: blur(12px);
  }

  .logo { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 15px; letter-spacing: 0.04em; color: var(--text-dim); }
  .logo em { color: #3a4a5a; font-style: normal; }
  .logo span { color: #2a3040; font-weight: 400; font-size: 12px; margin-left: 10px; }
  /* Strikethrough on the title to underscore the obsolete nature */
  .logo s { text-decoration-color: var(--accent-rose); text-decoration-thickness: 2px; color: #4a5570; }

  .status-badge {
    font-size: 9px; letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--accent-rose); border: 1px solid rgba(255,77,109,0.3);
    padding: 3px 8px; border-radius: 3px;
    background: rgba(255,77,109,0.06);
  }

  .legend { display: flex; gap: 14px; align-items: center; }
  .leg-item { display: flex; align-items: center; gap: 5px; font-size: 9px; color: var(--text-dim); }
  .leg-dot { width: 8px; height: 8px; border-radius: 50%; border: 1.5px solid currentColor; }

  .controls { display: flex; gap: 8px; }
  .ctrl-btn {
    background: var(--surface); border: 1px solid var(--border);
    color: var(--text-dim); font-family: 'JetBrains Mono', monospace;
    font-size: 11px; padding: 5px 12px; border-radius: 4px; cursor: pointer; transition: all 0.15s;
  }
  .ctrl-btn:hover { border-color: var(--accent-dim); color: #6a7090; }

  #canvas-wrap { position: absolute; inset: 0; top: 49px; overflow: hidden; cursor: grab; }
  #canvas-wrap:active { cursor: grabbing; }
  #graph-canvas { position: absolute; top: 0; left: 0; pointer-events: none; }
  #nodes-layer  { position: absolute; top: 0; left: 0; transform-origin: 0 0; }

  .node {
    position: absolute; background: var(--node-bg);
    border-radius: 6px; padding: 11px 14px; cursor: pointer;
    transition: transform 0.15s; min-width: 148px;
    transform: translate(-50%, -50%);
  }
  .node:hover  { transform: translate(-50%, -50%) scale(1.03); }
  .node.active { transform: translate(-50%, -50%) scale(1.05); }

  /* Intentionally muted glow â€” nothing works great here */
  .node-header { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
  .node-icon   { font-size: 13px; line-height: 1; }
  .node-title  { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 11px; letter-spacing: 0.02em; }
  .node-sub    { font-size: 9px; color: var(--text-dim); line-height: 1.5; margin-top: 2px; }
  .node-tag    { display: inline-block; font-size: 8px; padding: 2px 5px; border-radius: 3px; margin-top: 5px; font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase; }

  /* warn badge for broken things */
  .node-warn { font-size: 8px; color: var(--accent-rose); margin-top: 4px; display: block; letter-spacing: 0.04em; }

  /* Layers â€” deliberately lower saturation / opacity than other maps */
  .layer-entry    { border: 1.5px solid rgba(0,229,255,0.4);  box-shadow: 0 0 12px rgba(0,229,255,0.04); }
  .layer-entry    .node-title { color: rgba(0,229,255,0.7); }
  .layer-entry    .node-tag   { background: rgba(0,229,255,0.07); color: rgba(0,229,255,0.6); }

  .layer-broken   { border: 1.5px dashed rgba(255,77,109,0.5); box-shadow: 0 0 10px rgba(255,77,109,0.04); }
  .layer-broken   .node-title { color: rgba(255,77,109,0.75); }
  .layer-broken   .node-tag   { background: rgba(255,77,109,0.07); color: rgba(255,77,109,0.6); }

  .layer-stdlib   { border: 1.5px solid rgba(179,136,255,0.35); box-shadow: 0 0 10px rgba(179,136,255,0.03); }
  .layer-stdlib   .node-title { color: rgba(179,136,255,0.65); }
  .layer-stdlib   .node-tag   { background: rgba(179,136,255,0.07); color: rgba(179,136,255,0.55); }

  .layer-ext      { border: 1.5px solid rgba(68,138,255,0.35); box-shadow: 0 0 10px rgba(68,138,255,0.03); }
  .layer-ext      .node-title { color: rgba(68,138,255,0.7); }
  .layer-ext      .node-tag   { background: rgba(68,138,255,0.07); color: rgba(68,138,255,0.6); }

  .layer-build    { border: 1.5px solid rgba(255,179,0,0.35);  box-shadow: 0 0 10px rgba(255,179,0,0.03); }
  .layer-build    .node-title { color: rgba(255,179,0,0.65); }
  .layer-build    .node-tag   { background: rgba(255,179,0,0.07); color: rgba(255,179,0,0.55); }

  .layer-dead     { border: 1.5px dashed #1e2230; }
  .layer-dead     .node-title { color: #2e3448; }
  .layer-dead     .node-tag   { background: #111318; color: #2a3040; }
  .layer-dead     .node-sub   { color: #222636; }
  .layer-dead     .node-icon  { opacity: 0.25; }

  #info-panel {
    position: fixed; bottom: 24px; right: 24px; width: 285px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 8px; padding: 16px;
    transition: opacity 0.2s, transform 0.2s; z-index: 200;
    opacity: 0; transform: translateY(8px); pointer-events: none;
  }
  #info-panel.visible { opacity: 1; transform: translateY(0); pointer-events: all; }
  #info-panel h3 { font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 800; margin-bottom: 8px; }
  #info-panel p  { font-size: 10px; color: var(--text-dim); line-height: 1.7; }
  #info-panel .deps-list { margin-top: 10px; font-size: 9px; color: var(--text-dim); }
  #info-panel .deps-list span { display: inline-block; padding: 2px 7px; background: var(--border); border-radius: 3px; margin: 2px 2px 0 0; }

  #hint { position: fixed; bottom: 24px; left: 24px; font-size: 10px; color: #252a38; line-height: 1.8; }
</style>
</head>
<body>

<header>
  <div style="display:flex;align-items:center;gap:14px;">
    <span class="logo"><s>Python Video Downloader</s> <span>â€” Architecture Dependency Map</span></span>
    <span class="status-badge">âš  Obsolete</span>
  </div>
  <div class="legend">
    <div class="leg-item"><div class="leg-dot" style="color:rgba(0,229,255,0.5)"></div> Entry / Build</div>
    <div class="leg-item"><div class="leg-dot" style="color:rgba(255,77,109,0.6)"></div> Broken / Partial</div>
    <div class="leg-item"><div class="leg-dot" style="color:rgba(179,136,255,0.5)"></div> stdlib</div>
    <div class="leg-item"><div class="leg-dot" style="color:rgba(68,138,255,0.5)"></div> External</div>
    <div class="leg-item"><div class="leg-dot" style="color:rgba(255,179,0,0.5)"></div> Compile</div>
    <div class="leg-item"><div class="leg-dot" style="color:#1e2230"></div> Dead / No-op</div>
  </div>
  <div class="controls">
    <button class="ctrl-btn" onclick="resetView()">â†º Reset</button>
    <button class="ctrl-btn" onclick="zoomIn()">+ Zoom</button>
    <button class="ctrl-btn" onclick="zoomOut()">âˆ’ Zoom</button>
  </div>
</header>

<div id="canvas-wrap">
  <canvas id="graph-canvas"></canvas>
  <div id="nodes-layer"></div>
</div>

<div id="info-panel">
  <h3 id="ip-title">â€”</h3>
  <p id="ip-desc">â€”</p>
  <div class="deps-list" id="ip-deps"></div>
</div>

<div id="hint"></div>

<script>
const nodes = [

  // â”€â”€ Entry Scripts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { id: 'main_essential', x: 280, y: 100, layer: 'entry', icon: 'ðŸ“„', title: 'main-essential-build.py',
    sub: 'GUI-only build\nSimpler, yt-dlp as module', tag: 'Python Script',
    desc: 'The "clean" build. A Tkinter GUI that calls yt-dlp directly as a Python module (not a subprocess). Simpler code, no threading, no live progress. Downloads work and files play correctly. Requires: os, sys, json, requests, subprocess, yt-dlp (pip), tkinter. The more reliable of the two scripts.',
    deps: ['tkinter', 'yt_dlp_module', 'os', 'sys', 'json', 'requests', 'subprocess_mod'] },

  { id: 'test_full', x: 720, y: 100, layer: 'broken', icon: 'âš ï¸', title: 'test-full-build.py',
    sub: 'Threaded GUI build\n"Works" â€” format error on play', tag: 'Python Script âš ',
    warn: 'âš  Output file unplayable in media players. Works in editing software only.',
    desc: 'The more ambitious but broken build. Uses threading for live download progress display via a Tkinter GUI. Calls yt-dlp.exe as a subprocess rather than using the Python module. Faster than main-essential-build.py but the output file has a format error â€” it plays in editing software but not in standard media players. An older version, never fixed.',
    deps: ['tkinter', 'yt_dlp_exe', 'os', 'sys', 'json', 'subprocess_mod', 'threading'] },

  { id: 'test_sys', x: 1100, y: 100, layer: 'dead', icon: 'ðŸ§ª', title: 'test-sys-vars.py',
    sub: 'Dev scratch file\nNo production use', tag: 'Dev Scratch',
    desc: 'Personal scratch file for prototyping new code before integrating into test-full-build.py. Has no connection to any running build. Included in the repo for completeness. No use to anyone else.',
    deps: [] },

  { id: 'untitled', x: 1280, y: 100, layer: 'dead', icon: 'â“', title: 'Untitled-1.py',
    sub: 'Unknown remnant\nForgotten experiment', tag: 'Unknown',
    desc: 'An unnamed Python file, likely a forgotten experiment or partial implementation. Not referenced anywhere in the project and has no documented purpose. A classic artifact of a first project.',
    deps: [] },

  // â”€â”€ stdlib modules â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { id: 'tkinter', x: 150, y: 300, layer: 'stdlib', icon: 'ðŸ–¼', title: 'tkinter',
    sub: 'Python stdlib GUI\npip install tkinter', tag: 'Python stdlib',
    desc: 'Standard Python GUI toolkit. Wraps the Tcl/Tk engine. Used by both scripts to produce the download window with a URL input field and download button. The readme incorrectly lists it as a pip install â€” tkinter ships with CPython and does not need to be pip-installed.',
    deps: ['python_runtime'] },

  { id: 'os', x: 340, y: 300, layer: 'stdlib', icon: 'ðŸ’»', title: 'os',
    sub: 'OS interface\nPath & env access', tag: 'Python stdlib',
    desc: 'Python standard library os module. Used for file path construction, checking file existence, and interacting with the operating system environment. Both scripts rely on it for locating yt-dlp.exe and output directories.',
    deps: ['python_runtime'] },

  { id: 'sys', x: 460, y: 300, layer: 'stdlib', icon: 'âš™ï¸', title: 'sys',
    sub: 'System access\nArgs & interpreter info', tag: 'Python stdlib',
    desc: 'Python standard library sys module. Used to access the Python interpreter path, command-line arguments, and exit the process on error.',
    deps: ['python_runtime'] },

  { id: 'json', x: 570, y: 300, layer: 'stdlib', icon: '{}', title: 'json',
    sub: 'JSON parse/write\nConfig or metadata', tag: 'Python stdlib',
    desc: 'Python standard library json module. Used in both scripts, likely for reading or writing a small config or for parsing yt-dlp metadata output.',
    deps: ['python_runtime'] },

  { id: 'subprocess_mod', x: 680, y: 300, layer: 'stdlib', icon: 'ðŸ”€', title: 'subprocess',
    sub: 'Spawn child processes\nyt-dlp.exe invocation', tag: 'Python stdlib',
    desc: 'Python standard library subprocess module. Central to test-full-build.py â€” used to invoke yt-dlp.exe as a child process and pipe its stdout back to the GUI for live progress display. Also present in main-essential-build.py for ancillary process calls.',
    deps: ['python_runtime'] },

  { id: 'threading', x: 800, y: 300, layer: 'stdlib', icon: 'ðŸ§µ', title: 'threading',
    sub: 'Background download\nKeeps GUI responsive', tag: 'Python stdlib',
    desc: 'Python standard library threading module. Used only in test-full-build.py to run the yt-dlp.exe subprocess on a background thread, keeping the Tkinter event loop responsive and allowing live progress text to update during download. Works â€” but the resulting file has a format error.',
    deps: ['python_runtime'] },

  { id: 'requests', x: 280, y: 300, layer: 'ext', icon: 'ðŸŒ', title: 'requests',
    sub: 'HTTP client\npip install requests', tag: 'pip Package',
    desc: 'Third-party HTTP library. Used in main-essential-build.py â€” likely for checking network connectivity, fetching video metadata, or downloading ancillary resources. Adds a dependency that could have been avoided with urllib from stdlib.',
    deps: ['python_runtime'] },

  // â”€â”€ External binaries / modules â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { id: 'yt_dlp_module', x: 200, y: 490, layer: 'ext', icon: 'â–¶ï¸', title: 'yt-dlp (module)',
    sub: 'pip install yt-dlp\nUsed in main-essential', tag: 'pip Package',
    desc: 'yt-dlp installed as a Python package via pip. Used by main-essential-build.py â€” called directly as a Python API rather than as a subprocess. Cleaner integration, no bundling headaches, but no live progress output to the GUI.',
    deps: ['python_runtime'] },

  { id: 'yt_dlp_exe', x: 720, y: 490, layer: 'ext', icon: 'â–¶ï¸', title: 'yt-dlp.exe',
    sub: '19.5 MB binary\nBundled in repo root', tag: 'External Binary',
    warn: 'âš  Bundled directly in repo root. Must be in same directory as script.',
    desc: 'yt-dlp.exe â€” the standalone yt-dlp binary (19.5 MB), committed directly into the repository root. Used by test-full-build.py via subprocess. Bundling the exe in the repo is the root cause of much of the complexity. No auto-install yet â€” the readme notes this as a known issue to fix.',
    deps: ['ffmpeg_internal'] },

  { id: 'ffmpeg_internal', x: 720, y: 660, layer: 'broken', icon: 'ðŸŽž', title: 'ffmpeg (internal)',
    sub: 'Embedded in yt-dlp.exe\nMuxing broken for playback', tag: 'Bundled Dep',
    warn: 'âš  Output plays in editors, not in media players.',
    desc: 'ffmpeg is embedded within yt-dlp.exe for stream muxing. The format error that makes output files unplayable in media players (but functional in editing software) likely stems from an ffmpeg muxing misconfiguration â€” incorrect container format, missing moov atom, or incompatible codec flags produced by the subprocess call chain. Never diagnosed or fixed.',
    deps: [] },

  // â”€â”€ Python Runtime â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { id: 'python_runtime', x: 500, y: 660, layer: 'entry', icon: 'ðŸ', title: 'Python Interpreter',
    sub: 'CPython runtime\nRequired for .py scripts', tag: 'Python Runtime',
    desc: 'CPython interpreter required to run either .py script. Must be installed separately. The readme correctly notes this as a prerequisite. The compile path (auto-py-to-exe) bundles a copy of the interpreter into the .exe to remove this requirement for end users.',
    deps: [] },

  // â”€â”€ Compile Path â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { id: 'auto_py_to_exe', x: 1050, y: 300, layer: 'build', icon: 'ðŸ”§', title: 'auto-py-to-exe',
    sub: 'PyInstaller GUI wrapper\nProduces .exe bundles', tag: 'Build Tool',
    desc: 'auto-py-to-exe wraps PyInstaller to produce the two .exe builds. Configured to bundle the Python interpreter, tkinter, yt-dlp module, and all stdlib dependencies. Used to produce both Video-Downloader-GUI.exe and the console variant.',
    deps: ['pyinstaller'] },

  { id: 'pyinstaller', x: 1050, y: 490, layer: 'build', icon: 'ðŸ“¦', title: 'PyInstaller',
    sub: 'Bundle â†’ .exe\nBootloader + interpreter', tag: 'Compiler',
    desc: 'PyInstaller collects all imports from the entry script, bundles them with the CPython interpreter and a bootloader, and produces a self-contained .exe. Each of the two builds (GUI, console) is ~31 MB because the full interpreter and all pip packages are included.',
    deps: ['python_runtime'] },

  { id: 'exe_gui', x: 880, y: 660, layer: 'build', icon: 'ðŸ’¾', title: 'Video-Downloader-GUI.exe',
    sub: '31.1 MB standalone\nRequires 7-zip to unpack deps', tag: 'Output Binary',
    warn: 'âš  Requires 7-zip installed. Unusual runtime dependency.',
    desc: 'The windowed (no console) .exe build. 31.1 MB. PyInstaller bundles everything including the Python runtime. Unusually, end users must have 7-zip installed â€” it is used at runtime to unpack dependencies rather than having PyInstaller handle this cleanly. A sign of the bundling getting out of hand.',
    deps: ['seven_zip'] },

  { id: 'exe_console', x: 1050, y: 660, layer: 'build', icon: 'ðŸ’¾', title: 'Video-Downloader-Console.exe',
    sub: '31.1 MB standalone\nConsole + GUI variant', tag: 'Output Binary',
    warn: 'âš  Requires 7-zip installed.',
    desc: 'The console-windowed variant of the same build â€” shows a terminal alongside the GUI for debug output. Also 31.1 MB. Functionally identical to the GUI build but with the console window visible. Both .exe files are committed to the repo despite being 30+ MB each.',
    deps: ['seven_zip'] },

  { id: 'seven_zip', x: 1050, y: 840, layer: 'broken', icon: 'ðŸ—œ', title: '7-zip',
    sub: 'Must be pre-installed\nRuntime unpack dependency', tag: 'External Tool',
    warn: 'âš  A compiled .exe requiring a separate install to run defeats the purpose.',
    desc: '7-zip must be installed on the end-user\'s system before the .exe will run. It is used at runtime to unpack bundled dependencies. This is an unusual and fragile design â€” a self-contained PyInstaller binary should not require any pre-installed tools. This was the moment that made the whole approach feel untenable, and directly motivated rebuilding the downloader in C# with YoutubeDLSharp.',
    deps: [] },

  { id: 'todo', x: 1280, y: 300, layer: 'dead', icon: 'ðŸ“‹', title: 'TODO',
    sub: 'Not really updated\nAbandoned task list', tag: 'Docs',
    desc: 'A TODO file that tracked planned improvements â€” auto-installing yt-dlp.exe, fixing the format error, adding 2x2 matrix support (wrong project), improving the GUI layout. Not meaningfully updated once the project stalled. The C# rewrite made this file permanently irrelevant.',
    deps: [] },
];

const edges = [
  // main-essential
  { from: 'main_essential', to: 'tkinter' },
  { from: 'main_essential', to: 'yt_dlp_module' },
  { from: 'main_essential', to: 'os' },
  { from: 'main_essential', to: 'sys' },
  { from: 'main_essential', to: 'json' },
  { from: 'main_essential', to: 'requests' },
  { from: 'main_essential', to: 'subprocess_mod' },

  // test-full
  { from: 'test_full', to: 'tkinter' },
  { from: 'test_full', to: 'yt_dlp_exe' },
  { from: 'test_full', to: 'os' },
  { from: 'test_full', to: 'sys' },
  { from: 'test_full', to: 'json' },
  { from: 'test_full', to: 'subprocess_mod' },
  { from: 'test_full', to: 'threading' },

  // stdlib â†’ runtime
  { from: 'tkinter',       to: 'python_runtime' },
  { from: 'os',            to: 'python_runtime' },
  { from: 'sys',           to: 'python_runtime' },
  { from: 'json',          to: 'python_runtime' },
  { from: 'subprocess_mod',to: 'python_runtime' },
  { from: 'threading',     to: 'python_runtime' },
  { from: 'requests',      to: 'python_runtime' },
  { from: 'yt_dlp_module', to: 'python_runtime' },

  // yt-dlp.exe â†’ ffmpeg
  { from: 'yt_dlp_exe',    to: 'ffmpeg_internal' },
  { from: 'subprocess_mod',to: 'yt_dlp_exe' },

  // compile path
  { from: 'main_essential', to: 'auto_py_to_exe' },
  { from: 'auto_py_to_exe', to: 'pyinstaller' },
  { from: 'pyinstaller',    to: 'exe_gui' },
  { from: 'pyinstaller',    to: 'exe_console' },
  { from: 'pyinstaller',    to: 'python_runtime' },
  { from: 'exe_gui',        to: 'seven_zip' },
  { from: 'exe_console',    to: 'seven_zip' },
];

// â”€â”€â”€ Viewport â€” graph spans x:150â€“1280, y:100â€“840. Centre â‰ˆ (715, 470) â”€â”€â”€â”€â”€â”€
const GRAPH_CX = 715;
const GRAPH_CY = 470;
let scale = 1;
let offsetX = window.innerWidth  / 2 - GRAPH_CX;
let offsetY = window.innerHeight / 2 - GRAPH_CY;
let isDragging = false, dragStart = { x: 0, y: 0 };
let activeNode = null;

const wrap       = document.getElementById('canvas-wrap');
const canvas     = document.getElementById('graph-canvas');
const ctx        = canvas.getContext('2d');
const nodesLayer = document.getElementById('nodes-layer');
const infoPanel  = document.getElementById('info-panel');

const layerColors = {
  entry: '#00e5ff', broken: '#ff4d6d', stdlib: '#b388ff',
  ext: '#448aff', build: '#ffb300', dead: '#2a3040'
};

const nodeMap = {};
nodes.forEach(n => {
  const el = document.createElement('div');
  el.className = `node layer-${n.layer}`;
  el.id = 'n_' + n.id;
  el.style.left = n.x + 'px';
  el.style.top  = n.y + 'px';
  el.innerHTML = `
    <div class="node-header">
      <span class="node-icon">${n.icon}</span>
      <span class="node-title">${n.title}</span>
    </div>
    <div class="node-sub">${n.sub}</div>
    ${n.warn ? `<span class="node-warn">${n.warn}</span>` : ''}
    <span class="node-tag">${n.tag}</span>
  `;
  el.addEventListener('click', e => { e.stopPropagation(); selectNode(n); });
  nodesLayer.appendChild(el);
  nodeMap[n.id] = { data: n, el };
});

function resizeCanvas() {
  canvas.width  = wrap.clientWidth;
  canvas.height = wrap.clientHeight;
  drawEdges();
}
window.addEventListener('resize', resizeCanvas);

function worldToScreen(x, y) {
  return { x: x * scale + offsetX, y: y * scale + offsetY };
}

function drawEdges() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  edges.forEach(e => {
    const a  = nodeMap[e.from].data;
    const b  = nodeMap[e.to].data;
    const as = worldToScreen(a.x, a.y);
    const bs = worldToScreen(b.x, b.y);

    const highlight = activeNode && (e.from === activeNode || e.to === activeNode);
    const hiColor   = layerColors[nodeMap[e.from].data.layer];
    const color     = highlight ? hiColor : '#191e2c';
    const alpha     = highlight ? 0.8 : 0.7;

    ctx.beginPath();
    ctx.moveTo(as.x, as.y);
    const cpY = (as.y + bs.y) / 2;
    ctx.bezierCurveTo(as.x, cpY, bs.x, cpY, bs.x, bs.y);
    ctx.strokeStyle = color;
    ctx.globalAlpha = alpha;
    ctx.lineWidth   = highlight ? 1.5 : 0.8;
    ctx.stroke();
    ctx.globalAlpha = 1;

    const angle = Math.atan2(bs.y - cpY, 0) + Math.PI / 2;
    const aSize = highlight ? 5 : 3;
    ctx.beginPath();
    ctx.moveTo(bs.x, bs.y);
    ctx.lineTo(bs.x - aSize * Math.cos(angle - Math.PI/6), bs.y - aSize * Math.sin(angle - Math.PI/6));
    ctx.lineTo(bs.x - aSize * Math.cos(angle + Math.PI/6), bs.y - aSize * Math.sin(angle + Math.PI/6));
    ctx.closePath();
    ctx.fillStyle   = color;
    ctx.globalAlpha = alpha;
    ctx.fill();
    ctx.globalAlpha = 1;
  });
}

function applyTransform() {
  nodesLayer.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
  drawEdges();
}

wrap.addEventListener('mousedown', e => {
  isDragging = true;
  dragStart  = { x: e.clientX - offsetX, y: e.clientY - offsetY };
  wrap.style.cursor = 'grabbing';
});
window.addEventListener('mousemove', e => {
  if (!isDragging) return;
  offsetX = e.clientX - dragStart.x;
  offsetY = e.clientY - dragStart.y;
  applyTransform();
});
window.addEventListener('mouseup', () => { isDragging = false; wrap.style.cursor = 'grab'; });

let lastTouchDist = null;
wrap.addEventListener('touchstart', e => {
  e.preventDefault();
  if (e.touches.length === 1) {
    isDragging = true;
    dragStart  = { x: e.touches[0].clientX - offsetX, y: e.touches[0].clientY - offsetY };
  } else if (e.touches.length === 2) {
    lastTouchDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
  }
}, { passive: false });
wrap.addEventListener('touchmove', e => {
  e.preventDefault();
  if (e.touches.length === 1 && isDragging) {
    offsetX = e.touches[0].clientX - dragStart.x;
    offsetY = e.touches[0].clientY - dragStart.y;
    applyTransform();
  } else if (e.touches.length === 2) {
    const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
    if (lastTouchDist) {
      const factor = dist / lastTouchDist;
      const mx = (e.touches[0].clientX + e.touches[1].clientX) / 2;
      const my = (e.touches[0].clientY + e.touches[1].clientY) / 2;
      offsetX = mx + (offsetX - mx) * factor;
      offsetY = my + (offsetY - my) * factor;
      scale   = Math.max(0.15, Math.min(2.5, scale * factor));
      applyTransform();
    }
    lastTouchDist = dist;
  }
}, { passive: false });
wrap.addEventListener('touchend', () => { isDragging = false; lastTouchDist = null; });

wrap.addEventListener('wheel', e => {
  e.preventDefault();
  const factor = e.deltaY > 0 ? 0.92 : 1.08;
  const rect   = wrap.getBoundingClientRect();
  const mx = e.clientX - rect.left, my = e.clientY - rect.top;
  offsetX = mx + (offsetX - mx) * factor;
  offsetY = my + (offsetY - my) * factor;
  scale   = Math.max(0.15, Math.min(2.5, scale * factor));
  applyTransform();
}, { passive: false });

function zoomIn()  { scale = Math.min(scale * 1.15, 2.5); applyTransform(); }
function zoomOut() { scale = Math.max(scale * 0.85, 0.15); applyTransform(); }
function resetView() {
  scale   = 1;
  offsetX = window.innerWidth  / 2 - GRAPH_CX;
  offsetY = window.innerHeight / 2 - GRAPH_CY;
  applyTransform();
  deselectNode();
}

function selectNode(n) {
  if (activeNode) document.getElementById('n_' + activeNode)?.classList.remove('active');
  activeNode = n.id;
  document.getElementById('n_' + n.id)?.classList.add('active');
  document.getElementById('ip-title').textContent = n.title;
  document.getElementById('ip-title').style.color = layerColors[n.layer];
  document.getElementById('ip-desc').textContent  = n.desc;
  const depLabels = (n.deps || []).map(d => {
    const found = nodes.find(x => x.id === d);
    return found ? `<span>${found.title}</span>` : '';
  }).join('');
  document.getElementById('ip-deps').innerHTML = depLabels
    ? `<div style="margin-bottom:5px;color:#2a3040">Depends on:</div>${depLabels}` : '';
  infoPanel.classList.add('visible');
  drawEdges();
}
function deselectNode() {
  if (activeNode) document.getElementById('n_' + activeNode)?.classList.remove('active');
  activeNode = null;
  infoPanel.classList.remove('visible');
  drawEdges();
}
wrap.addEventListener('click', deselectNode);

const isTouchDevice = ('ontouchstart' in window) || navigator.maxTouchPoints > 0;
document.getElementById('hint').innerHTML = isTouchDevice
  ? 'ðŸ‘† Drag to pan &nbsp;Â·&nbsp; Pinch to zoom &nbsp;Â·&nbsp; Tap node for details'
  : 'ðŸ–± Drag to pan &nbsp;Â·&nbsp; Scroll to zoom &nbsp;Â·&nbsp; Click node for details';

resizeCanvas();
applyTransform();
</script>
</body>
</html>