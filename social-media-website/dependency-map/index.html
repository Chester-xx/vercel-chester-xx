<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>@Connect â€” Dependency Map</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600;700&family=Syne:wght@400;700;800&display=swap');

  :root {
    --bg: #0a0c10;
    --surface: #111318;
    --border: #1e2230;
    --accent-cyan: #00e5ff;
    --accent-amber: #ffb300;
    --accent-rose: #ff4d6d;
    --accent-green: #00e676;
    --accent-purple: #b388ff;
    --accent-blue: #448aff;
    --text: #e0e6f0;
    --text-dim: #5a6480;
    --node-bg: #151822;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'JetBrains Mono', monospace;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    overflow: hidden;
    user-select: none;
  }

  header {
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 24px;
    background: rgba(10,12,16,0.92);
    border-bottom: 1px solid var(--border);
    backdrop-filter: blur(12px);
  }

  .logo {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 16px;
    letter-spacing: 0.05em;
    color: var(--accent-purple);
  }
  .logo span { color: var(--text-dim); font-weight: 400; font-size: 13px; margin-left: 10px; }

  .legend {
    display: flex;
    gap: 16px;
    align-items: center;
    flex-wrap: wrap;
  }
  .leg-item {
    display: flex; align-items: center; gap: 6px;
    font-size: 10px; color: var(--text-dim);
  }
  .leg-dot {
    width: 10px; height: 10px; border-radius: 50%;
    border: 2px solid currentColor;
  }

  .controls { display: flex; gap: 8px; }
  .ctrl-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text-dim);
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    padding: 5px 12px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .ctrl-btn:hover { border-color: var(--accent-purple); color: var(--accent-purple); }

  #canvas-wrap {
    position: absolute;
    inset: 0;
    top: 49px;
    overflow: hidden;
    cursor: grab;
  }
  #canvas-wrap:active { cursor: grabbing; }

  #graph-canvas {
    position: absolute;
    top: 0; left: 0;
    pointer-events: none;
  }

  #nodes-layer {
    position: absolute;
    top: 0; left: 0;
    transform-origin: 0 0;
  }

  .node {
    position: absolute;
    background: var(--node-bg);
    border-radius: 8px;
    padding: 12px 16px;
    cursor: pointer;
    transition: transform 0.15s, box-shadow 0.15s;
    min-width: 155px;
    transform: translate(-50%, -50%);
  }
  .node:hover { transform: translate(-50%, -50%) scale(1.04); }
  .node.active { transform: translate(-50%, -50%) scale(1.06); }

  .node-header { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
  .node-icon { font-size: 14px; line-height: 1; }
  .node-title {
    font-family: 'Syne', sans-serif;
    font-weight: 700; font-size: 12px; letter-spacing: 0.03em;
  }
  .node-sub { font-size: 9px; color: var(--text-dim); line-height: 1.5; margin-top: 2px; }
  .node-tag {
    display: inline-block; font-size: 8px; padding: 2px 6px;
    border-radius: 3px; margin-top: 6px; font-weight: 600;
    letter-spacing: 0.06em; text-transform: uppercase;
  }

  .layer-entry   { border: 1.5px solid var(--accent-cyan);   box-shadow: 0 0 18px rgba(0,229,255,0.10); }
  .layer-entry   .node-title { color: var(--accent-cyan); }
  .layer-entry   .node-tag   { background: rgba(0,229,255,0.12); color: var(--accent-cyan); }

  .layer-ui      { border: 1.5px solid var(--accent-purple); box-shadow: 0 0 18px rgba(179,136,255,0.10); }
  .layer-ui      .node-title { color: var(--accent-purple); }
  .layer-ui      .node-tag   { background: rgba(179,136,255,0.12); color: var(--accent-purple); }

  .layer-core    { border: 1.5px solid var(--accent-amber);  box-shadow: 0 0 18px rgba(255,179,0,0.10); }
  .layer-core    .node-title { color: var(--accent-amber); }
  .layer-core    .node-tag   { background: rgba(255,179,0,0.12); color: var(--accent-amber); }

  .layer-api     { border: 1.5px solid var(--accent-green);  box-shadow: 0 0 18px rgba(0,230,118,0.10); }
  .layer-api     .node-title { color: var(--accent-green); }
  .layer-api     .node-tag   { background: rgba(0,230,118,0.12); color: var(--accent-green); }

  .layer-system  { border: 1.5px solid var(--accent-rose);   box-shadow: 0 0 18px rgba(255,77,109,0.10); }
  .layer-system  .node-title { color: var(--accent-rose); }
  .layer-system  .node-tag   { background: rgba(255,77,109,0.12); color: var(--accent-rose); }

  .layer-db      { border: 1.5px solid var(--accent-blue);   box-shadow: 0 0 18px rgba(68,138,255,0.10); }
  .layer-db      .node-title { color: var(--accent-blue); }
  .layer-db      .node-tag   { background: rgba(68,138,255,0.12); color: var(--accent-blue); }

  #info-panel {
    position: fixed;
    bottom: 24px; right: 24px;
    width: 290px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 18px;
    transition: opacity 0.2s, transform 0.2s;
    z-index: 200;
    opacity: 0; transform: translateY(8px); pointer-events: none;
  }
  #info-panel.visible { opacity: 1; transform: translateY(0); pointer-events: all; }
  #info-panel h3 { font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 800; margin-bottom: 8px; }
  #info-panel p  { font-size: 10px; color: var(--text-dim); line-height: 1.7; }
  #info-panel .deps-list { margin-top: 10px; font-size: 9px; color: var(--text-dim); }
  #info-panel .deps-list span { display: inline-block; padding: 2px 7px; background: var(--border); border-radius: 3px; margin: 2px 2px 0 0; }

  #hint { position: fixed; bottom: 24px; left: 24px; font-size: 10px; color: var(--text-dim); line-height: 1.8; }
</style>
</head>
<body>

<header>
  <div>
    <span class="logo">@Connect <span>â€” Architecture Dependency Map</span></span>
  </div>
  <div class="legend">
    <div class="leg-item"><div class="leg-dot" style="color:var(--accent-cyan)"></div> Entry</div>
    <div class="leg-item"><div class="leg-dot" style="color:var(--accent-purple)"></div> UI / Pages</div>
    <div class="leg-item"><div class="leg-dot" style="color:var(--accent-amber)"></div> PHP Backend</div>
    <div class="leg-item"><div class="leg-dot" style="color:var(--accent-green)"></div> API Layer</div>
    <div class="leg-item"><div class="leg-dot" style="color:var(--accent-rose)"></div> System / Infra</div>
    <div class="leg-item"><div class="leg-dot" style="color:var(--accent-blue)"></div> Database</div>
  </div>
  <div class="controls">
    <button class="ctrl-btn" onclick="resetView()">â†º Reset</button>
    <button class="ctrl-btn" onclick="zoomIn()">+ Zoom</button>
    <button class="ctrl-btn" onclick="zoomOut()">âˆ’ Zoom</button>
  </div>
</header>

<div id="canvas-wrap">
  <canvas id="graph-canvas"></canvas>
  <div id="nodes-layer"></div>
</div>

<div id="info-panel">
  <h3 id="ip-title">â€”</h3>
  <p id="ip-desc">â€”</p>
  <div class="deps-list" id="ip-deps"></div>
</div>

<div id="hint"></div>

<script>
// â”€â”€â”€ Graph Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const nodes = [

  // â”€â”€ Entry â”€â”€
  { id: 'index', x: 660, y: 100, layer: 'entry', icon: 'âš¡', title: 'index.php',
    sub: 'Landing router\nSession check â†’ redirect', tag: 'Entry Point',
    desc: 'Root landing page. Starts a PHP session and checks for an active UserID. Authenticated users are forwarded to /dashboard, unauthenticated users to /login. No UI of its own.',
    deps: ['session', 'dashboard', 'login_page'] },

  // â”€â”€ UI / Pages â”€â”€
  { id: 'login_page', x: 200, y: 280, layer: 'ui', icon: 'ðŸ”', title: '/login',
    sub: 'Login Â· Sign Up\nForgot password link', tag: 'PHP Page',
    desc: 'Login page directory. Contains login form (email + password), sign-up registration form, and a link to the password-reset flow. Submits to PHP backend handlers on the same page via POST.',
    deps: ['auth_core', 'session', 'style'] },

  { id: 'password_page', x: 460, y: 280, layer: 'ui', icon: 'ðŸ”‘', title: '/password',
    sub: 'Forgot password\nToken email Â· Reset form', tag: 'PHP Page',
    desc: 'Password reset flow. Takes the user\'s email, validates account existence, generates a SHA256 token stored in tblPasswordResets, and presents a localhost test link. Reset form validates token and updates password.',
    deps: ['auth_core', 'session', 'db_connect', 'style'] },

  { id: 'dashboard', x: 660, y: 280, layer: 'ui', icon: 'ðŸ ', title: '/dashboard',
    sub: 'Feed Â· Create Post\nRecents / Following tabs', tag: 'PHP Page',
    desc: 'Primary application page. Renders the nav bar, create-post area (text + media upload), and the post feed. Switches between Recents (all posts) and Following (friends only) tabs. All post/like/comment interactions are driven by AJAX calls to /api.',
    deps: ['includes', 'session', 'api_posts', 'api_users', 'style'] },

  { id: 'users_page', x: 900, y: 280, layer: 'ui', icon: 'ðŸ‘¤', title: '/users',
    sub: 'Own profile Â· Other profiles\nFollow / Unfollow', tag: 'PHP Page',
    desc: 'Profile page. Detects whether the viewed profile belongs to the logged-in user or another account. Own profile shows post creation, friends list, follow requests, and settings link. Other profiles show follow/unfollow/cancel-request buttons.',
    deps: ['includes', 'session', 'api_users', 'api_posts', 'style'] },

  { id: 'messages_page', x: 1140, y: 280, layer: 'ui', icon: 'ðŸ’¬', title: '/dashboard/messages',
    sub: 'Conversations Â· DM thread\nSearch users to chat', tag: 'PHP Page',
    desc: 'Messaging interface. Lists active conversations from tblMessages. Search bar finds users to start new conversations. Clicking a conversation loads the message thread. Sending a message POSTs to /api/messages. Responsive for desktop and mobile.',
    deps: ['includes', 'session', 'api_messages', 'api_search', 'style'] },

  { id: 'search_page', x: 1340, y: 280, layer: 'ui', icon: 'ðŸ”', title: '/dashboard/search',
    sub: 'Username search\nUser preview cards', tag: 'PHP Page',
    desc: 'Search page. Text input queries /api/search for matching usernames. Results are rendered as user preview cards that link to the matching /users profile page.',
    deps: ['includes', 'session', 'api_search', 'style'] },

  { id: 'settings_page', x: 1140, y: 460, layer: 'ui', icon: 'âš™ï¸', title: '/dashboard/settings',
    sub: 'Change username Â· pfp\nLogout Â· Delete account', tag: 'PHP Page',
    desc: 'Account settings page. Lets the user change their username and profile picture. Also provides logout (calls /logout.php) and account deletion, which cascades removal of all user data via ON DELETE CASCADE constraints.',
    deps: ['includes', 'session', 'api_users', 'style'] },

  { id: 'logout', x: 460, y: 460, layer: 'system', icon: 'ðŸšª', title: 'logout.php',
    sub: 'Session destroy\nRedirect to /login', tag: 'PHP Script',
    desc: 'Destroys the current PHP session and unsets all session variables, then redirects the user to /login. Called from the settings page.',
    deps: ['session'] },

  // â”€â”€ PHP Backend / Includes â”€â”€
  { id: 'includes', x: 660, y: 460, layer: 'core', icon: 'ðŸ“¦', title: '/includes',
    sub: 'Shared PHP modules\nDB Â· auth Â· helpers', tag: 'PHP Includes',
    desc: 'Shared PHP include directory. Contains reusable modules: database connection (dbconnect.php), session auth guard (checks UserID and redirects if not logged in), and common helper functions used across all pages.',
    deps: ['db_connect', 'session'] },

  { id: 'auth_core', x: 200, y: 460, layer: 'core', icon: 'ðŸ›¡', title: 'Auth Logic',
    sub: 'Login Â· Register\nPassword hash Â· SHA256', tag: 'PHP Backend',
    desc: 'Authentication PHP logic embedded in /login pages. Validates POST fields, checks email existence against tblUsers, compares SHA256-hashed passwords, creates session on success. Registration checks uniqueness of email/username, hashes password, and inserts into tblUsers.',
    deps: ['db_connect', 'session', 'tbl_users'] },

  // â”€â”€ API Layer â”€â”€
  { id: 'api_posts', x: 300, y: 660, layer: 'api', icon: 'ðŸ“', title: '/api/posts',
    sub: 'Create Â· Fetch Â· Like\nComment Â· Delete', tag: 'PHP API',
    desc: 'Posts API endpoint group. Handles: fetching recent or following-filtered posts (GET with AJAX), creating new posts with optional media upload to /content/posts (POST), toggling likes in tblLikes, and adding/fetching comments in tblComments.',
    deps: ['db_connect', 'session', 'tbl_posts', 'tbl_likes', 'tbl_comments', 'content_store'] },

  { id: 'api_messages', x: 580, y: 660, layer: 'api', icon: 'âœ‰ï¸', title: '/api/messages',
    sub: 'Send Â· Fetch thread\nConversation list', tag: 'PHP API',
    desc: 'Messages API endpoint group. Fetches conversation list (distinct SenderID/ReceiverID pairs from tblMessages), loads a full message thread between two users, and handles new message insertion via POST.',
    deps: ['db_connect', 'session', 'tbl_messages'] },

  { id: 'api_search', x: 840, y: 660, layer: 'api', icon: 'ðŸ”Ž', title: '/api/search',
    sub: 'Username search\nReturns user matches', tag: 'PHP API',
    desc: 'Search API endpoint. Accepts a username query string, runs a LIKE query against tblUsers.Username, and returns matching user records (UserID, Username, pfpPath) as JSON for AJAX rendering.',
    deps: ['db_connect', 'session', 'tbl_users'] },

  { id: 'api_users', x: 1080, y: 660, layer: 'api', icon: 'ðŸ‘¥', title: '/api/users',
    sub: 'Profile data Â· Follow\nFriends Â· Requests', tag: 'PHP API',
    desc: 'Users API endpoint group. Handles: fetching user profile data, sending/cancelling/accepting follow requests (tblFollowRequests), managing confirmed followers (tblFollowers), updating profile image and username, and account deletion.',
    deps: ['db_connect', 'session', 'tbl_users', 'tbl_followers', 'tbl_follow_requests', 'content_store'] },

  // â”€â”€ System / Infra â”€â”€
  { id: 'session', x: 660, y: 640, layer: 'system', icon: 'ðŸ”’', title: 'PHP Sessions',
    sub: 'UserID state\nAuth guard Â· CSRF', tag: 'PHP Runtime',
    desc: 'PHP native session system. session_start() is called on every page. $_SESSION["UserID"] is the primary auth token â€” its presence determines if a user is logged in. All pages guard against unauthorized access by checking this value and redirecting if absent.',
    deps: [] },

  { id: 'xampp', x: 900, y: 460, layer: 'system', icon: 'ðŸ–¥', title: 'XAMPP / Apache',
    sub: 'Local dev server\nPHP runtime Â· htdocs', tag: 'Infrastructure',
    desc: 'XAMPP provides the full local development stack: Apache HTTP server, PHP runtime, and MySQL via MariaDB. All project files live under htdocs/. phpMyAdmin is available but not configured for this project.',
    deps: ['db_connect'] },

  { id: 'style', x: 1320, y: 460, layer: 'system', icon: 'ðŸŽ¨', title: '/style',
    sub: 'Global CSS\nResponsive Â· mobile', tag: 'CSS',
    desc: 'Global stylesheet directory. Contains shared CSS for typography, layout, component styling, and responsive breakpoints. Tested in Chrome desktop and mobile view. Applied across all pages via link tags.',
    deps: [] },

  // â”€â”€ Database â”€â”€
  { id: 'db_connect', x: 300, y: 880, layer: 'db', icon: 'ðŸ—„', title: 'dbConnect',
    sub: 'mysqli connection\nMySQL Â· XAMPP', tag: 'MySQL Database',
    desc: 'The main MySQL database. Connection established via mysqli in PHP (includes/dbconnect.php). All 8 tables live here. All relational tables use ON DELETE CASCADE. Managed via phpMyAdmin in XAMPP.',
    deps: ['tbl_users', 'tbl_posts', 'tbl_messages', 'tbl_comments', 'tbl_likes', 'tbl_followers', 'tbl_follow_requests', 'tbl_pw_resets'] },

  { id: 'tbl_users', x: 60, y: 1080, layer: 'db', icon: 'ðŸ§‘', title: 'tblUsers',
    sub: 'UserID Â· Email\nUsername Â· pfpPath', tag: 'MySQL Table',
    desc: 'Primary user table. Stores UserID (PK, auto_inc), Email (unique), Password (SHA256 hashed), Username (unique, 50 chars), FullName (100 chars), and pfpPath (default: "default.jpg"). Central FK target for all other tables.',
    deps: [] },

  { id: 'tbl_posts', x: 300, y: 1080, layer: 'db', icon: 'ðŸ“„', title: 'tblPosts',
    sub: 'PostID Â· UserID FK\nContent Â· Image Â· Time', tag: 'MySQL Table',
    desc: 'Stores all posts. PostID (PK), UserID (FK â†’ tblUsers), Content (text), Image (nullable varchar, relative path to /content/posts), CreateTime (datetime, current_timestamp).',
    deps: [] },

  { id: 'tbl_messages', x: 540, y: 1080, layer: 'db', icon: 'âœ‰ï¸', title: 'tblMessages',
    sub: 'SenderID Â· ReceiverID\nMessage Â· SentAt', tag: 'MySQL Table',
    desc: 'Private message store. MessageID (PK), SenderID (FK â†’ tblUsers), ReceiverID (FK â†’ tblUsers), Message (text), SentAt (datetime, current_timestamp).',
    deps: [] },

  { id: 'tbl_comments', x: 780, y: 1080, layer: 'db', icon: 'ðŸ’­', title: 'tblComments',
    sub: 'CommentID Â· PostID FK\nUserID FK Â· Content', tag: 'MySQL Table',
    desc: 'Stores all post comments. CommentID (PK), PostID (FK â†’ tblPosts), UserID (FK â†’ tblUsers), Content (text), CreateTime (datetime). ON DELETE CASCADE removes comments when a post or user is deleted.',
    deps: [] },

  { id: 'tbl_likes', x: 1020, y: 1080, layer: 'db', icon: 'â¤ï¸', title: 'tblLikes',
    sub: 'LikeID Â· UserID FK\nPostID FK Â· LikeDate', tag: 'MySQL Table',
    desc: 'Tracks individual likes. LikeID (PK), UserID (FK â†’ tblUsers), PostID (FK â†’ tblPosts), LikeDate (datetime). One row per like â€” toggled by the API (insert on like, delete on unlike).',
    deps: [] },

  { id: 'tbl_followers', x: 1260, y: 1080, layer: 'db', icon: 'ðŸ¤', title: 'tblFollowers',
    sub: 'FollowerID Â· UserID FK\nUserFollowerID FK', tag: 'MySQL Table',
    desc: 'Confirmed friendship/follower relations. FollowerID (PK), UserID (FK â†’ tblUsers), UserFollowerID (FK â†’ tblUsers). A row here means the relationship is active and bidirectional queries are used for the Following feed.',
    deps: [] },

  { id: 'tbl_follow_requests', x: 1460, y: 1080, layer: 'db', icon: 'ðŸ“¨', title: 'tblFollowRequests',
    sub: 'RequestID Â· FromID FK\nToID FK Â· Pending', tag: 'MySQL Table',
    desc: 'Pending follow requests awaiting accept/decline. RequestID (PK), FromID (FK â†’ tblUsers), ToID (FK â†’ tblUsers). Row is deleted and moved to tblFollowers on accept, or simply deleted on decline/cancel.',
    deps: [] },

  { id: 'tbl_pw_resets', x: 1680, y: 1080, layer: 'db', icon: 'ðŸ”„', title: 'tblPasswordResets',
    sub: 'Token Â· Email FK\nExpires Â· datetime', tag: 'MySQL Table',
    desc: 'Temporary password reset token store. ResetID (PK), Email (FK â†’ tblUsers.Email), Token (SHA256 hashed), Expires (datetime). Token is validated on the reset page and the row is deleted once the password is successfully changed.',
    deps: [] },

  // â”€â”€ Content Storage â”€â”€
  { id: 'content_store', x: 1500, y: 660, layer: 'system', icon: 'ðŸ–¼', title: '/content',
    sub: 'Post media Â· Profile photos\n/posts Â· /profiles Â· /assets', tag: 'File Storage',
    desc: 'Public file storage directory under htdocs. /content/posts stores uploaded post images/gifs/videos as relative paths referenced in tblPosts.Image. /content/profiles stores user profile photos (+ default.jpg). Accessible via URL â€” a known security tradeoff noted for future improvement.',
    deps: [] },
];

const edges = [
  // Entry routing
  { from: 'index',         to: 'dashboard' },
  { from: 'index',         to: 'login_page' },
  { from: 'index',         to: 'session' },

  // Login / auth
  { from: 'login_page',    to: 'auth_core' },
  { from: 'login_page',    to: 'session' },
  { from: 'login_page',    to: 'style' },
  { from: 'password_page', to: 'auth_core' },
  { from: 'password_page', to: 'db_connect' },
  { from: 'password_page', to: 'style' },
  { from: 'auth_core',     to: 'db_connect' },
  { from: 'auth_core',     to: 'session' },
  { from: 'auth_core',     to: 'tbl_users' },

  // Dashboard
  { from: 'dashboard',     to: 'includes' },
  { from: 'dashboard',     to: 'session' },
  { from: 'dashboard',     to: 'api_posts' },
  { from: 'dashboard',     to: 'api_users' },
  { from: 'dashboard',     to: 'style' },
  { from: 'dashboard',     to: 'messages_page' },
  { from: 'dashboard',     to: 'search_page' },
  { from: 'dashboard',     to: 'settings_page' },
  { from: 'dashboard',     to: 'users_page' },

  // Users / Profile
  { from: 'users_page',    to: 'includes' },
  { from: 'users_page',    to: 'session' },
  { from: 'users_page',    to: 'api_users' },
  { from: 'users_page',    to: 'api_posts' },
  { from: 'users_page',    to: 'style' },

  // Messages
  { from: 'messages_page', to: 'includes' },
  { from: 'messages_page', to: 'session' },
  { from: 'messages_page', to: 'api_messages' },
  { from: 'messages_page', to: 'api_search' },
  { from: 'messages_page', to: 'style' },

  // Search
  { from: 'search_page',   to: 'includes' },
  { from: 'search_page',   to: 'session' },
  { from: 'search_page',   to: 'api_search' },
  { from: 'search_page',   to: 'style' },

  // Settings
  { from: 'settings_page', to: 'includes' },
  { from: 'settings_page', to: 'session' },
  { from: 'settings_page', to: 'api_users' },
  { from: 'settings_page', to: 'logout' },
  { from: 'settings_page', to: 'style' },
  { from: 'logout',        to: 'session' },

  // Includes
  { from: 'includes',      to: 'db_connect' },
  { from: 'includes',      to: 'session' },

  // API â†’ DB
  { from: 'api_posts',     to: 'db_connect' },
  { from: 'api_posts',     to: 'session' },
  { from: 'api_posts',     to: 'tbl_posts' },
  { from: 'api_posts',     to: 'tbl_likes' },
  { from: 'api_posts',     to: 'tbl_comments' },
  { from: 'api_posts',     to: 'content_store' },

  { from: 'api_messages',  to: 'db_connect' },
  { from: 'api_messages',  to: 'session' },
  { from: 'api_messages',  to: 'tbl_messages' },

  { from: 'api_search',    to: 'db_connect' },
  { from: 'api_search',    to: 'session' },
  { from: 'api_search',    to: 'tbl_users' },

  { from: 'api_users',     to: 'db_connect' },
  { from: 'api_users',     to: 'session' },
  { from: 'api_users',     to: 'tbl_users' },
  { from: 'api_users',     to: 'tbl_followers' },
  { from: 'api_users',     to: 'tbl_follow_requests' },
  { from: 'api_users',     to: 'content_store' },

  // DB â†’ Tables
  { from: 'db_connect',    to: 'tbl_users' },
  { from: 'db_connect',    to: 'tbl_posts' },
  { from: 'db_connect',    to: 'tbl_messages' },
  { from: 'db_connect',    to: 'tbl_comments' },
  { from: 'db_connect',    to: 'tbl_likes' },
  { from: 'db_connect',    to: 'tbl_followers' },
  { from: 'db_connect',    to: 'tbl_follow_requests' },
  { from: 'db_connect',    to: 'tbl_pw_resets' },

  // Infra
  { from: 'xampp',         to: 'db_connect' },
  { from: 'password_page', to: 'tbl_pw_resets' },
];

// â”€â”€â”€ Viewport state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Graph spans x: 60â€“1680, y: 100â€“1080. Center â‰ˆ (870, 590)
const GRAPH_CX = 870;
const GRAPH_CY = 590;
let scale = 1;
let offsetX = window.innerWidth  / 2 - GRAPH_CX * scale;
let offsetY = window.innerHeight / 2 - GRAPH_CY * scale;
let isDragging = false, dragStart = {x:0,y:0};
let activeNode = null;

const wrap = document.getElementById('canvas-wrap');
const canvas = document.getElementById('graph-canvas');
const ctx = canvas.getContext('2d');
const nodesLayer = document.getElementById('nodes-layer');
const infoPanel = document.getElementById('info-panel');

const layerColors = {
  entry: '#00e5ff', ui: '#b388ff', core: '#ffb300',
  api: '#00e676', system: '#ff4d6d', db: '#448aff'
};

// â”€â”€â”€ Build DOM nodes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const nodeMap = {};
nodes.forEach(n => {
  const el = document.createElement('div');
  el.className = `node layer-${n.layer}`;
  el.id = 'n_' + n.id;
  el.style.left = n.x + 'px';
  el.style.top  = n.y + 'px';
  el.innerHTML = `
    <div class="node-header">
      <span class="node-icon">${n.icon}</span>
      <span class="node-title">${n.title}</span>
    </div>
    <div class="node-sub">${n.sub}</div>
    <span class="node-tag">${n.tag}</span>
  `;
  el.addEventListener('click', e => { e.stopPropagation(); selectNode(n); });
  nodesLayer.appendChild(el);
  nodeMap[n.id] = { data: n, el };
});

// â”€â”€â”€ Canvas resize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resizeCanvas() {
  canvas.width  = wrap.clientWidth;
  canvas.height = wrap.clientHeight;
  drawEdges();
}
window.addEventListener('resize', resizeCanvas);

function worldToScreen(x, y) {
  return { x: x * scale + offsetX, y: y * scale + offsetY };
}

function getNodeCenter(id) {
  const n = nodeMap[id].data;
  return { x: n.x, y: n.y };
}

function drawEdges() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  edges.forEach(e => {
    const a  = getNodeCenter(e.from);
    const b  = getNodeCenter(e.to);
    const as = worldToScreen(a.x, a.y);
    const bs = worldToScreen(b.x, b.y);

    const highlight = activeNode && (e.from === activeNode || e.to === activeNode);
    const color = highlight ? layerColors[nodeMap[e.from].data.layer] : '#1e2230';
    const alpha = highlight ? 0.9 : 0.6;

    ctx.beginPath();
    ctx.moveTo(as.x, as.y);
    const cpY = (as.y + bs.y) / 2;
    ctx.bezierCurveTo(as.x, cpY, bs.x, cpY, bs.x, bs.y);
    ctx.strokeStyle = color;
    ctx.globalAlpha = alpha;
    ctx.lineWidth = highlight ? 2 : 1;
    ctx.stroke();
    ctx.globalAlpha = 1;

    const angle = Math.atan2(bs.y - cpY, bs.x - bs.x) + Math.PI / 2;
    const aSize = highlight ? 6 : 4;
    ctx.beginPath();
    ctx.moveTo(bs.x, bs.y);
    ctx.lineTo(bs.x - aSize * Math.cos(angle - Math.PI/6), bs.y - aSize * Math.sin(angle - Math.PI/6));
    ctx.lineTo(bs.x - aSize * Math.cos(angle + Math.PI/6), bs.y - aSize * Math.sin(angle + Math.PI/6));
    ctx.closePath();
    ctx.fillStyle = color;
    ctx.globalAlpha = alpha;
    ctx.fill();
    ctx.globalAlpha = 1;
  });
}

function applyTransform() {
  nodesLayer.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
  drawEdges();
}

// â”€â”€â”€ Pan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
wrap.addEventListener('mousedown', e => {
  isDragging = true;
  dragStart = { x: e.clientX - offsetX, y: e.clientY - offsetY };
  wrap.style.cursor = 'grabbing';
});
window.addEventListener('mousemove', e => {
  if (!isDragging) return;
  offsetX = e.clientX - dragStart.x;
  offsetY = e.clientY - dragStart.y;
  applyTransform();
});
window.addEventListener('mouseup', () => {
  isDragging = false;
  wrap.style.cursor = 'grab';
});

// â”€â”€â”€ Touch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lastTouchDist = null;

wrap.addEventListener('touchstart', e => {
  e.preventDefault();
  if (e.touches.length === 1) {
    isDragging = true;
    dragStart = { x: e.touches[0].clientX - offsetX, y: e.touches[0].clientY - offsetY };
  } else if (e.touches.length === 2) {
    lastTouchDist = Math.hypot(
      e.touches[0].clientX - e.touches[1].clientX,
      e.touches[0].clientY - e.touches[1].clientY
    );
  }
}, { passive: false });

wrap.addEventListener('touchmove', e => {
  e.preventDefault();
  if (e.touches.length === 1 && isDragging) {
    offsetX = e.touches[0].clientX - dragStart.x;
    offsetY = e.touches[0].clientY - dragStart.y;
    applyTransform();
  } else if (e.touches.length === 2) {
    const dist = Math.hypot(
      e.touches[0].clientX - e.touches[1].clientX,
      e.touches[0].clientY - e.touches[1].clientY
    );
    if (lastTouchDist) {
      const factor = dist / lastTouchDist;
      const mx = (e.touches[0].clientX + e.touches[1].clientX) / 2;
      const my = (e.touches[0].clientY + e.touches[1].clientY) / 2;
      offsetX = mx + (offsetX - mx) * factor;
      offsetY = my + (offsetY - my) * factor;
      scale = Math.max(0.15, Math.min(2.5, scale * factor));
      applyTransform();
    }
    lastTouchDist = dist;
  }
}, { passive: false });

wrap.addEventListener('touchend', () => {
  isDragging = false;
  lastTouchDist = null;
});

// â”€â”€â”€ Zoom â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
wrap.addEventListener('wheel', e => {
  e.preventDefault();
  const factor = e.deltaY > 0 ? 0.92 : 1.08;
  const rect = wrap.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;
  offsetX = mx + (offsetX - mx) * factor;
  offsetY = my + (offsetY - my) * factor;
  scale = Math.max(0.15, Math.min(2.5, scale * factor));
  applyTransform();
}, { passive: false });

function zoomIn()  { scale = Math.min(scale * 1.15, 2.5); applyTransform(); }
function zoomOut() { scale = Math.max(scale * 0.85, 0.15); applyTransform(); }
function resetView() {
  scale = 1;
  offsetX = window.innerWidth  / 2 - GRAPH_CX * scale;
  offsetY = window.innerHeight / 2 - GRAPH_CY * scale;
  applyTransform();
  deselectNode();
}

// â”€â”€â”€ Node selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectNode(n) {
  if (activeNode) document.getElementById('n_' + activeNode)?.classList.remove('active');
  activeNode = n.id;
  document.getElementById('n_' + n.id)?.classList.add('active');

  document.getElementById('ip-title').textContent = n.title;
  document.getElementById('ip-title').style.color = layerColors[n.layer];
  document.getElementById('ip-desc').textContent  = n.desc;

  const depLabels = (n.deps || []).map(d => {
    const found = nodes.find(x => x.id === d);
    return found ? `<span>${found.title}</span>` : '';
  }).join('');
  document.getElementById('ip-deps').innerHTML = depLabels
    ? `<div style="margin-bottom:5px;color:#5a6480">Depends on:</div>${depLabels}`
    : '';

  infoPanel.classList.add('visible');
  drawEdges();
}

function deselectNode() {
  if (activeNode) document.getElementById('n_' + activeNode)?.classList.remove('active');
  activeNode = null;
  infoPanel.classList.remove('visible');
  drawEdges();
}

wrap.addEventListener('click', deselectNode);

// â”€â”€â”€ Hint â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const isTouchDevice = ('ontouchstart' in window) || navigator.maxTouchPoints > 0;
document.getElementById('hint').innerHTML = isTouchDevice
  ? 'ðŸ‘† Drag to pan &nbsp;Â·&nbsp; Pinch to zoom &nbsp;Â·&nbsp; Tap node for details'
  : 'ðŸ–± Drag to pan &nbsp;Â·&nbsp; Scroll to zoom &nbsp;Â·&nbsp; Click node for details';

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
resizeCanvas();
applyTransform();
</script>
</body>
</html>
