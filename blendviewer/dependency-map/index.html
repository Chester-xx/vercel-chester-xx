<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BlendViewer â€” Dependency Map</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600;700&family=Syne:wght@400;700;800&display=swap');

  :root {
    --bg: #0a0c10;
    --surface: #111318;
    --border: #1e2230;
    --accent-cyan: #00e5ff;
    --accent-amber: #ffb300;
    --accent-rose: #ff4d6d;
    --accent-green: #00e676;
    --accent-purple: #b388ff;
    --accent-blue: #448aff;
    --text: #e0e6f0;
    --text-dim: #5a6480;
    --node-bg: #151822;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'JetBrains Mono', monospace;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    overflow: hidden;
    user-select: none;
  }

  /* Header */
  header {
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 24px;
    background: rgba(10,12,16,0.92);
    border-bottom: 1px solid var(--border);
    backdrop-filter: blur(12px);
  }

  .logo {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 16px;
    letter-spacing: 0.05em;
    color: var(--accent-cyan);
  }
  .logo span { color: var(--text-dim); font-weight: 400; font-size: 13px; margin-left: 10px; }

  .legend {
    display: flex;
    gap: 18px;
    align-items: center;
  }
  .leg-item {
    display: flex; align-items: center; gap: 6px;
    font-size: 10px; color: var(--text-dim);
  }
  .leg-dot {
    width: 10px; height: 10px; border-radius: 50%;
    border: 2px solid currentColor;
  }

  .controls {
    display: flex; gap: 8px;
  }
  .ctrl-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text-dim);
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    padding: 5px 12px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .ctrl-btn:hover { border-color: var(--accent-cyan); color: var(--accent-cyan); }

  /* Canvas */
  #canvas-wrap {
    position: absolute;
    inset: 0;
    top: 49px;
    overflow: hidden;
    cursor: grab;
  }
  #canvas-wrap:active { cursor: grabbing; }

  #graph-canvas {
    position: absolute;
    top: 0; left: 0;
    pointer-events: none;
  }

  #nodes-layer {
    position: absolute;
    top: 0; left: 0;
    transform-origin: 0 0;
  }

  /* Nodes */
  .node {
    position: absolute;
    background: var(--node-bg);
    border-radius: 8px;
    padding: 12px 16px;
    cursor: pointer;
    transition: transform 0.15s, box-shadow 0.15s;
    min-width: 160px;
    transform: translate(-50%, -50%);
  }
  .node:hover { transform: translate(-50%, -50%) scale(1.04); }
  .node.active { transform: translate(-50%, -50%) scale(1.06); }

  .node-header {
    display: flex; align-items: center; gap: 8px;
    margin-bottom: 6px;
  }
  .node-icon {
    font-size: 14px; line-height: 1;
  }
  .node-title {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 12px;
    letter-spacing: 0.03em;
  }
  .node-sub {
    font-size: 9px;
    color: var(--text-dim);
    line-height: 1.5;
    margin-top: 2px;
  }
  .node-tag {
    display: inline-block;
    font-size: 8px;
    padding: 2px 6px;
    border-radius: 3px;
    margin-top: 6px;
    font-weight: 600;
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }

  /* Color variants */
  .layer-entry   { border: 1.5px solid var(--accent-cyan);   box-shadow: 0 0 18px rgba(0,229,255,0.10); }
  .layer-entry   .node-title { color: var(--accent-cyan); }
  .layer-entry   .node-tag { background: rgba(0,229,255,0.12); color: var(--accent-cyan); }

  .layer-ui      { border: 1.5px solid var(--accent-purple); box-shadow: 0 0 18px rgba(179,136,255,0.10); }
  .layer-ui      .node-title { color: var(--accent-purple); }
  .layer-ui      .node-tag { background: rgba(179,136,255,0.12); color: var(--accent-purple); }

  .layer-core    { border: 1.5px solid var(--accent-amber);  box-shadow: 0 0 18px rgba(255,179,0,0.10); }
  .layer-core    .node-title { color: var(--accent-amber); }
  .layer-core    .node-tag { background: rgba(255,179,0,0.12); color: var(--accent-amber); }

  .layer-render  { border: 1.5px solid var(--accent-green);  box-shadow: 0 0 18px rgba(0,230,118,0.10); }
  .layer-render  .node-title { color: var(--accent-green); }
  .layer-render  .node-tag { background: rgba(0,230,118,0.12); color: var(--accent-green); }

  .layer-system  { border: 1.5px solid var(--accent-rose);   box-shadow: 0 0 18px rgba(255,77,109,0.10); }
  .layer-system  .node-title { color: var(--accent-rose); }
  .layer-system  .node-tag { background: rgba(255,77,109,0.12); color: var(--accent-rose); }

  .layer-ext     { border: 1.5px solid var(--accent-blue);   box-shadow: 0 0 18px rgba(68,138,255,0.10); }
  .layer-ext     .node-title { color: var(--accent-blue); }
  .layer-ext     .node-tag { background: rgba(68,138,255,0.12); color: var(--accent-blue); }

  /* Info panel */
  #info-panel {
    position: fixed;
    bottom: 24px; right: 24px;
    width: 280px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 18px;
    transition: opacity 0.2s, transform 0.2s;
    z-index: 200;
    opacity: 0;
    transform: translateY(8px);
    pointer-events: none;
  }
  #info-panel.visible {
    opacity: 1; transform: translateY(0); pointer-events: all;
  }
  #info-panel h3 {
    font-family: 'Syne', sans-serif;
    font-size: 14px; font-weight: 800;
    margin-bottom: 8px;
  }
  #info-panel p {
    font-size: 10px; color: var(--text-dim); line-height: 1.7;
  }
  #info-panel .deps-list {
    margin-top: 10px;
    font-size: 9px;
    color: var(--text-dim);
  }
  #info-panel .deps-list span {
    display: inline-block;
    padding: 2px 7px;
    background: var(--border);
    border-radius: 3px;
    margin: 2px 2px 0 0;
  }

  /* Hint */
  #hint {
    position: fixed;
    bottom: 24px; left: 24px;
    font-size: 10px; color: var(--text-dim);
    line-height: 1.8;
  }
</style>
</head>
<body>

<header>
  <div>
    <span class="logo">BlendViewer <span>â€” Architecture Dependency Map</span></span>
  </div>
  <div class="legend">
    <div class="leg-item"><div class="leg-dot" style="color:var(--accent-cyan)"></div> Entry</div>
    <div class="leg-item"><div class="leg-dot" style="color:var(--accent-purple)"></div> UI / QML</div>
    <div class="leg-item"><div class="leg-dot" style="color:var(--accent-amber)"></div> C++ Core</div>
    <div class="leg-item"><div class="leg-dot" style="color:var(--accent-green)"></div> Rendering</div>
    <div class="leg-item"><div class="leg-dot" style="color:var(--accent-rose)"></div> System</div>
    <div class="leg-item"><div class="leg-dot" style="color:var(--accent-blue)"></div> External</div>
  </div>
  <div class="controls">
    <button class="ctrl-btn" onclick="resetView()">â†º Reset</button>
    <button class="ctrl-btn" onclick="zoomIn()">+ Zoom</button>
    <button class="ctrl-btn" onclick="zoomOut()">âˆ’ Zoom</button>
  </div>
</header>

<div id="canvas-wrap">
  <canvas id="graph-canvas"></canvas>
  <div id="nodes-layer"></div>
</div>

<div id="info-panel">
  <h3 id="ip-title">â€”</h3>
  <p id="ip-desc">â€”</p>
  <div class="deps-list" id="ip-deps"></div>
</div>

<div id="hint">
  ðŸ–± Drag to pan &nbsp;Â·&nbsp; Scroll to zoom &nbsp;Â·&nbsp; Click node for details
</div>

<script>
// â”€â”€â”€ Graph Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const nodes = [
  // Entry
  { id: 'main_cpp', x: 500, y: 120, layer: 'entry', icon: 'âš¡', title: 'main.cpp', sub: 'Qt Application Entry\nQGuiApplication init', tag: 'C++ Entry',
    desc: 'Entry point of the application. Initializes QGuiApplication, registers QML types, sets up the QML engine, and loads main.qml.',
    deps: ['qml_engine', 'qt_core', 'qt_qml'] },

  // UI Layer
  { id: 'qml_engine', x: 500, y: 280, layer: 'ui', icon: 'ðŸ”·', title: 'QML Engine', sub: 'Loads & runs main.qml\nProperty bindings', tag: 'Qt QML',
    desc: 'The QQmlApplicationEngine loads main.qml and manages the entire declarative UI tree. It bridges C++ backend objects into QML context.',
    deps: ['main_qml', 'qt_quick'] },

  { id: 'main_qml', x: 300, y: 430, layer: 'ui', icon: 'ðŸªŸ', title: 'main.qml', sub: 'Root window\nLayout orchestration', tag: 'QML',
    desc: 'Root QML file. Defines ApplicationWindow, hosts left sidebar, center viewport, right toolbar, and bottom status bar. Orchestrates all UI sub-components.',
    deps: ['sidebar', 'viewport', 'toolbar', 'statusbar'] },

  { id: 'sidebar', x: 100, y: 580, layer: 'ui', icon: 'ðŸŽ›', title: 'Left Sidebar', sub: 'Camera controls\nEnvironment settings', tag: 'QML',
    desc: 'Contains sliders for Rotation X/Y, Distance, Camera Speed. Quick View preset buttons (Top, Bottom, Persp, Left, Front, Right). Bound to camera backend via signals & slots.',
    deps: ['camera_ctrl'] },

  { id: 'toolbar', x: 700, y: 580, layer: 'ui', icon: 'ðŸ”§', title: 'Right Toolbar', sub: 'Select / Move / Rotate\nScale / Wireframe', tag: 'QML',
    desc: 'Tool selection strip. Provides Select, Move, Rotate, Scale, and Wireframe toggle. Feeds input mode state to the C++ input handler.',
    deps: ['input_sys'] },

  { id: 'statusbar', x: 300, y: 720, layer: 'ui', icon: 'ðŸ“Š', title: 'Status Bar', sub: 'Meshes / Vertices\nMaterials / FPS', tag: 'QML',
    desc: 'Bottom bar showing live scene statistics: mesh count, vertex count, material count, FPS counter, WebGL/Qt backend version, and model load status.',
    deps: ['scene_data'] },

  // C++ Core
  { id: 'viewport', x: 500, y: 580, layer: 'core', icon: 'ðŸ–¼', title: 'Viewport (View3D)', sub: 'SceneLoader host\nCamera + Lighting', tag: 'Qt Quick 3D',
    desc: 'The central QQuick3D View3D element. Hosts SceneLoader for glTF import, PerspectiveCamera, and DirectionalLight. Renders the 3D scene into the QML surface.',
    deps: ['scene_loader', 'camera_ctrl', 'lighting'] },

  { id: 'camera_ctrl', x: 150, y: 780, layer: 'core', icon: 'ðŸŽ¥', title: 'Camera Controller', sub: 'Rotation X/Y/Z\nZoom Â· Presets', tag: 'C++ Backend',
    desc: 'C++ class (QObject) exposed to QML. Manages PerspectiveCamera position, rotation angles, zoom distance, speed, and handles preset view transitions.',
    deps: ['qt_core', 'qt_gui'] },

  { id: 'input_sys', x: 700, y: 780, layer: 'core', icon: 'âŒ¨ï¸', title: 'Input System', sub: 'WASD Â· Slider events\nTool state machine', tag: 'C++ Backend',
    desc: 'Handles keyboard (WASD movement), slider value changes, and button events. Dispatches commands to camera or transform tools. Routes active tool state.',
    deps: ['qt_core'] },

  { id: 'file_handler', x: 500, y: 780, layer: 'core', icon: 'ðŸ“‚', title: 'File Handler', sub: '.gltf / .glb loading\nDrag & drop Â· Status', tag: 'C++ Backend',
    desc: 'Manages file open dialogs and drag & drop events. Reads .gltf and .glb binary streams. Feeds the model URI to SceneLoader and emits load status signals.',
    deps: ['scene_loader', 'qt_core'] },

  // Rendering Layer
  { id: 'scene_loader', x: 400, y: 950, layer: 'render', icon: 'ðŸ“¦', title: 'SceneLoader', sub: 'glTF import\nMesh / Material parse', tag: 'Qt Quick 3D',
    desc: 'Qt Quick 3D SceneLoader component. Parses glTF/glB assets: meshes, materials, textures, animations. Populates the 3D scene graph inside View3D.',
    deps: ['qt_quick3d', 'shader_tools'] },

  { id: 'lighting', x: 620, y: 950, layer: 'render', icon: 'ðŸ’¡', title: 'Lighting', sub: 'DirectionalLight\nEnvironment IBL', tag: 'Qt Quick 3D',
    desc: 'Scene lighting setup: DirectionalLight for primary illumination, SceneEnvironment for IBL (Image-Based Lighting) presets (Studio Soft, etc.).',
    deps: ['qt_quick3d'] },

  { id: 'scene_data', x: 180, y: 950, layer: 'render', icon: 'ðŸ§®', title: 'Scene Statistics', sub: 'Mesh/Vertex/Material\ncount + FPS', tag: 'C++ Backend',
    desc: 'C++ model that aggregates scene statistics post-load: mesh count, vertex count, material count. Also drives the FPS counter using a QTimer.',
    deps: ['qt_core', 'scene_loader'] },

  // System / Build
  { id: 'shader_tools', x: 400, y: 1100, layer: 'system', icon: 'ðŸ”º', title: 'Qt ShaderTools', sub: 'GLSL / shader compile\nMaterial pipeline', tag: 'Qt Module',
    desc: 'Qt ShaderTools processes and compiles GLSL shaders at build time. Enables custom material and shader experimentation for the rendering pipeline.',
    deps: ['qt_quick3d'] },

  { id: 'windeployqt', x: 700, y: 950, layer: 'system', icon: 'ðŸ“¦', title: 'windeployqt', sub: 'Deployment automation\nRelease packaging', tag: 'Build Tool',
    desc: 'Post-build automation tool. Copies required Qt DLLs, QML plugins, and platform plugins alongside the release executable. Followed by cleanup scripts.',
    deps: [] },

  // External / Qt Modules
  { id: 'qt_core',    x: 100, y: 1100, layer: 'ext', icon: 'âš™ï¸', title: 'Qt Core',    sub: 'QObject Â· QTimer\nSignals & Slots', tag: 'Qt 6 Module', desc: 'Foundation Qt module providing QObject, property system, signals & slots, event loop, and file I/O primitives.', deps: [] },
  { id: 'qt_gui',     x: 280, y: 1100, layer: 'ext', icon: 'ðŸ–±', title: 'Qt GUI',     sub: 'Input events\nSurface abstraction', tag: 'Qt 6 Module', desc: 'Provides window/surface abstraction, input event handling (mouse, keyboard), and OpenGL surface integration.', deps: [] },
  { id: 'qt_qml',     x: 620, y: 1100, layer: 'ext', icon: 'ðŸ“', title: 'Qt QML',     sub: 'QML runtime\nContext properties', tag: 'Qt 6 Module', desc: 'QML language runtime. Exposes C++ objects to QML context. Manages declarative property bindings and JS engine.', deps: [] },
  { id: 'qt_quick',   x: 750, y: 1100, layer: 'ext', icon: 'âœ¨', title: 'Qt Quick',   sub: 'UI primitives\nAnimations', tag: 'Qt 6 Module', desc: 'Qt Quick provides the 2D UI primitives (Rectangle, Text, Image, etc.) and animation framework used by the QML UI.', deps: [] },
  { id: 'qt_quick3d', x: 550, y: 1230, layer: 'ext', icon: 'ðŸŒ', title: 'Qt Quick 3D', sub: 'View3D Â· Node3D\nglTF pipeline', tag: 'Qt 6 Module', desc: 'The 3D rendering module. Provides View3D, Node3D, Camera, Light, SceneLoader, and the full glTF import/render pipeline.', deps: [] },

  // VS + Extension
  { id: 'vs_qtvs', x: 850, y: 780, layer: 'system', icon: 'ðŸ› ', title: 'Visual Studio\n+ Qt VS Tools', sub: 'IDE Â· CMake\nbuild system', tag: 'Tooling', desc: 'Development IDE. Qt VS Tools extension integrates Qt project configuration, qmake/cmake, QML debugging, and resource compilation (qrc) directly into Visual Studio.', deps: ['windeployqt'] },
];

const edges = [
  { from: 'main_cpp',    to: 'qml_engine' },
  { from: 'main_cpp',    to: 'qt_core' },
  { from: 'main_cpp',    to: 'qt_qml' },
  { from: 'qml_engine',  to: 'main_qml' },
  { from: 'qml_engine',  to: 'qt_quick' },
  { from: 'main_qml',    to: 'sidebar' },
  { from: 'main_qml',    to: 'viewport' },
  { from: 'main_qml',    to: 'toolbar' },
  { from: 'main_qml',    to: 'statusbar' },
  { from: 'sidebar',     to: 'camera_ctrl' },
  { from: 'toolbar',     to: 'input_sys' },
  { from: 'viewport',    to: 'scene_loader' },
  { from: 'viewport',    to: 'camera_ctrl' },
  { from: 'viewport',    to: 'lighting' },
  { from: 'statusbar',   to: 'scene_data' },
  { from: 'camera_ctrl', to: 'qt_core' },
  { from: 'camera_ctrl', to: 'qt_gui' },
  { from: 'input_sys',   to: 'qt_core' },
  { from: 'file_handler',to: 'scene_loader' },
  { from: 'file_handler',to: 'qt_core' },
  { from: 'scene_loader',to: 'qt_quick3d' },
  { from: 'scene_loader',to: 'shader_tools' },
  { from: 'lighting',    to: 'qt_quick3d' },
  { from: 'scene_data',  to: 'qt_core' },
  { from: 'scene_data',  to: 'scene_loader' },
  { from: 'shader_tools',to: 'qt_quick3d' },
  { from: 'vs_qtvs',    to: 'windeployqt' },
  { from: 'main_cpp',    to: 'file_handler' },
  { from: 'vs_qtvs',    to: 'qt_core' },
];

// â”€â”€â”€ Viewport state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let scale = 1;
let offsetX = window.innerWidth / 2 - 500 * 1;
let offsetY = window.innerHeight / 2 - 600 * 1;
let isDragging = false, dragStart = {x:0,y:0}, dragOffset = {x:0,y:0};
let activeNode = null;

const wrap = document.getElementById('canvas-wrap');
const canvas = document.getElementById('graph-canvas');
const ctx = canvas.getContext('2d');
const nodesLayer = document.getElementById('nodes-layer');
const infoPanel = document.getElementById('info-panel');

const layerColors = {
  entry: '#00e5ff', ui: '#b388ff', core: '#ffb300',
  render: '#00e676', system: '#ff4d6d', ext: '#448aff'
};

// â”€â”€â”€ Build DOM nodes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const nodeMap = {};
nodes.forEach(n => {
  const el = document.createElement('div');
  el.className = `node layer-${n.layer}`;
  el.id = 'n_' + n.id;
  el.style.left = n.x + 'px';
  el.style.top = n.y + 'px';
  el.innerHTML = `
    <div class="node-header">
      <span class="node-icon">${n.icon}</span>
      <span class="node-title">${n.title}</span>
    </div>
    <div class="node-sub">${n.sub}</div>
    <span class="node-tag">${n.tag}</span>
  `;
  el.addEventListener('click', (e) => { e.stopPropagation(); selectNode(n); });
  nodesLayer.appendChild(el);
  nodeMap[n.id] = { data: n, el };
});

// â”€â”€â”€ Canvas resize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resizeCanvas() {
  canvas.width = wrap.clientWidth;
  canvas.height = wrap.clientHeight;
  drawEdges();
}
window.addEventListener('resize', resizeCanvas);

// â”€â”€â”€ Draw edges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function worldToScreen(x, y) {
  return { x: x * scale + offsetX, y: y * scale + offsetY };
}

function getNodeCenter(id) {
  const n = nodeMap[id].data;
  return { x: n.x, y: n.y };
}

function drawEdges() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  edges.forEach(e => {
    const a = getNodeCenter(e.from);
    const b = getNodeCenter(e.to);
    const as = worldToScreen(a.x, a.y);
    const bs = worldToScreen(b.x, b.y);

    const highlight = activeNode && (e.from === activeNode || e.to === activeNode);
    const color = highlight ? layerColors[nodeMap[e.from].data.layer] : '#1e2230';
    const alpha = highlight ? 0.9 : 0.6;

    ctx.beginPath();
    ctx.moveTo(as.x, as.y);
    const cpY = (as.y + bs.y) / 2;
    ctx.bezierCurveTo(as.x, cpY, bs.x, cpY, bs.x, bs.y);
    ctx.strokeStyle = color;
    ctx.globalAlpha = alpha;
    ctx.lineWidth = highlight ? 2 : 1;
    ctx.stroke();
    ctx.globalAlpha = 1;

    // Arrow
    const angle = Math.atan2(bs.y - cpY, bs.x - bs.x) + Math.PI / 2;
    const aSize = highlight ? 6 : 4;
    ctx.beginPath();
    ctx.moveTo(bs.x, bs.y);
    ctx.lineTo(bs.x - aSize * Math.cos(angle - Math.PI/6), bs.y - aSize * Math.sin(angle - Math.PI/6));
    ctx.lineTo(bs.x - aSize * Math.cos(angle + Math.PI/6), bs.y - aSize * Math.sin(angle + Math.PI/6));
    ctx.closePath();
    ctx.fillStyle = color;
    ctx.globalAlpha = alpha;
    ctx.fill();
    ctx.globalAlpha = 1;
  });
}

// â”€â”€â”€ Apply transform â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyTransform() {
  nodesLayer.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
  drawEdges();
}

// â”€â”€â”€ Pan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
wrap.addEventListener('mousedown', e => {
  isDragging = true;
  dragStart = { x: e.clientX - offsetX, y: e.clientY - offsetY };
  wrap.style.cursor = 'grabbing';
});
window.addEventListener('mousemove', e => {
  if (!isDragging) return;
  offsetX = e.clientX - dragStart.x;
  offsetY = e.clientY - dragStart.y;
  applyTransform();
});
window.addEventListener('mouseup', () => {
  isDragging = false;
  wrap.style.cursor = 'grab';
});

// â”€â”€â”€ Touch Support â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lastTouchDist = null;

wrap.addEventListener('touchstart', e => {
    e.preventDefault();
    if (e.touches.length === 1) {
        isDragging = true;
        dragStart = { x: e.touches[0].clientX - offsetX, y: e.touches[0].clientY - offsetY };
    } else if (e.touches.length === 2) {
        lastTouchDist = Math.hypot(
            e.touches[0].clientX - e.touches[1].clientX,
            e.touches[0].clientY - e.touches[1].clientY
        );
    }
}, { passive: false });

wrap.addEventListener('touchmove', e => {
    e.preventDefault();
    if (e.touches.length === 1 && isDragging) {
        offsetX = e.touches[0].clientX - dragStart.x;
        offsetY = e.touches[0].clientY - dragStart.y;
        applyTransform();
    } else if (e.touches.length === 2) {
        const dist = Math.hypot(
            e.touches[0].clientX - e.touches[1].clientX,
            e.touches[0].clientY - e.touches[1].clientY
        );
        if (lastTouchDist) {
            const factor = dist / lastTouchDist;
            const mx = (e.touches[0].clientX + e.touches[1].clientX) / 2;
            const my = (e.touches[0].clientY + e.touches[1].clientY) / 2;
            offsetX = mx + (offsetX - mx) * factor;
            offsetY = my + (offsetY - my) * factor;
            scale = Math.max(0.2, Math.min(2.5, scale * factor));
            applyTransform();
        }
        lastTouchDist = dist;
    }
}, { passive: false });

wrap.addEventListener('touchend', e => {
    isDragging = false;
    lastTouchDist = null;
});

// â”€â”€â”€ Zoom â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
wrap.addEventListener('wheel', e => {
  e.preventDefault();
  const factor = e.deltaY > 0 ? 0.92 : 1.08;
  const rect = wrap.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;
  offsetX = mx + (offsetX - mx) * factor;
  offsetY = my + (offsetY - my) * factor;
  scale *= factor;
  scale = Math.max(0.2, Math.min(2.5, scale));
  applyTransform();
}, { passive: false });

function zoomIn()  { scale = Math.min(scale * 1.15, 2.5); applyTransform(); }
function zoomOut() { scale = Math.max(scale * 0.85, 0.2); applyTransform(); }
function resetView() {
  scale = 1;
  offsetX = window.innerWidth / 2 - 500 * 1;
  offsetY = window.innerHeight / 2 - 600 * 1;
  applyTransform();
  deselectNode();
}

// â”€â”€â”€ Node selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectNode(n) {
  if (activeNode) document.getElementById('n_' + activeNode)?.classList.remove('active');
  activeNode = n.id;
  document.getElementById('n_' + n.id)?.classList.add('active');

  document.getElementById('ip-title').textContent = n.title;
  document.getElementById('ip-title').style.color = layerColors[n.layer];
  document.getElementById('ip-desc').textContent = n.desc;

  const depLabels = (n.deps || []).map(d => {
    const found = nodes.find(x => x.id === d);
    return found ? `<span>${found.title}</span>` : '';
  }).join('');
  document.getElementById('ip-deps').innerHTML = depLabels
    ? `<div style="margin-bottom:5px;color:#5a6480">Depends on:</div>${depLabels}`
    : '';

  infoPanel.classList.add('visible');
  drawEdges();
}

function deselectNode() {
  if (activeNode) document.getElementById('n_' + activeNode)?.classList.remove('active');
  activeNode = null;
  infoPanel.classList.remove('visible');
  drawEdges();
}

wrap.addEventListener('click', deselectNode);

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
resizeCanvas();
applyTransform();
</script>
</body>
</html>
