<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Video Downloader ‚Äî Dependency Map</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600;700&family=Syne:wght@400;700;800&display=swap');

  :root {
    --bg: #0a0c10;
    --surface: #111318;
    --border: #1e2230;
    --accent-cyan: #00e5ff;
    --accent-amber: #ffb300;
    --accent-rose: #ff4d6d;
    --accent-green: #00e676;
    --accent-purple: #b388ff;
    --accent-blue: #448aff;
    --text: #e0e6f0;
    --text-dim: #5a6480;
    --node-bg: #151822;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'JetBrains Mono', monospace;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    overflow: hidden;
    user-select: none;
  }

  header {
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 24px;
    background: rgba(10,12,16,0.92);
    border-bottom: 1px solid var(--border);
    backdrop-filter: blur(12px);
  }

  .logo {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 16px;
    letter-spacing: 0.05em;
    color: var(--accent-rose);
  }
  .logo span { color: var(--text-dim); font-weight: 400; font-size: 13px; margin-left: 10px; }

  .legend {
    display: flex;
    gap: 18px;
    align-items: center;
  }
  .leg-item {
    display: flex; align-items: center; gap: 6px;
    font-size: 10px; color: var(--text-dim);
  }
  .leg-dot {
    width: 10px; height: 10px; border-radius: 50%;
    border: 2px solid currentColor;
  }

  .controls {
    display: flex; gap: 8px;
  }
  .ctrl-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text-dim);
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    padding: 5px 12px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .ctrl-btn:hover { border-color: var(--accent-rose); color: var(--accent-rose); }

  #canvas-wrap {
    position: absolute;
    inset: 0;
    top: 49px;
    overflow: hidden;
    cursor: grab;
  }
  #canvas-wrap:active { cursor: grabbing; }

  #graph-canvas {
    position: absolute;
    top: 0; left: 0;
    pointer-events: none;
  }

  #nodes-layer {
    position: absolute;
    top: 0; left: 0;
    transform-origin: 0 0;
  }

  .node {
    position: absolute;
    background: var(--node-bg);
    border-radius: 8px;
    padding: 12px 16px;
    cursor: pointer;
    transition: transform 0.15s, box-shadow 0.15s;
    min-width: 160px;
    transform: translate(-50%, -50%);
  }
  .node:hover { transform: translate(-50%, -50%) scale(1.04); }
  .node.active { transform: translate(-50%, -50%) scale(1.06); }

  .node-header {
    display: flex; align-items: center; gap: 8px;
    margin-bottom: 6px;
  }
  .node-icon { font-size: 14px; line-height: 1; }
  .node-title {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 12px;
    letter-spacing: 0.03em;
  }
  .node-sub {
    font-size: 9px;
    color: var(--text-dim);
    line-height: 1.5;
    margin-top: 2px;
  }
  .node-tag {
    display: inline-block;
    font-size: 8px;
    padding: 2px 6px;
    border-radius: 3px;
    margin-top: 6px;
    font-weight: 600;
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }

  .layer-entry   { border: 1.5px solid var(--accent-cyan);   box-shadow: 0 0 18px rgba(0,229,255,0.10); }
  .layer-entry   .node-title { color: var(--accent-cyan); }
  .layer-entry   .node-tag { background: rgba(0,229,255,0.12); color: var(--accent-cyan); }

  .layer-ui      { border: 1.5px solid var(--accent-purple); box-shadow: 0 0 18px rgba(179,136,255,0.10); }
  .layer-ui      .node-title { color: var(--accent-purple); }
  .layer-ui      .node-tag { background: rgba(179,136,255,0.12); color: var(--accent-purple); }

  .layer-core    { border: 1.5px solid var(--accent-amber);  box-shadow: 0 0 18px rgba(255,179,0,0.10); }
  .layer-core    .node-title { color: var(--accent-amber); }
  .layer-core    .node-tag { background: rgba(255,179,0,0.12); color: var(--accent-amber); }

  .layer-service { border: 1.5px solid var(--accent-green);  box-shadow: 0 0 18px rgba(0,230,118,0.10); }
  .layer-service .node-title { color: var(--accent-green); }
  .layer-service .node-tag { background: rgba(0,230,118,0.12); color: var(--accent-green); }

  .layer-system  { border: 1.5px solid var(--accent-rose);   box-shadow: 0 0 18px rgba(255,77,109,0.10); }
  .layer-system  .node-title { color: var(--accent-rose); }
  .layer-system  .node-tag { background: rgba(255,77,109,0.12); color: var(--accent-rose); }

  .layer-ext     { border: 1.5px solid var(--accent-blue);   box-shadow: 0 0 18px rgba(68,138,255,0.10); }
  .layer-ext     .node-title { color: var(--accent-blue); }
  .layer-ext     .node-tag { background: rgba(68,138,255,0.12); color: var(--accent-blue); }

  #info-panel {
    position: fixed;
    bottom: 24px; right: 24px;
    width: 290px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 18px;
    transition: opacity 0.2s, transform 0.2s;
    z-index: 200;
    opacity: 0;
    transform: translateY(8px);
    pointer-events: none;
  }
  #info-panel.visible {
    opacity: 1; transform: translateY(0); pointer-events: all;
  }
  #info-panel h3 {
    font-family: 'Syne', sans-serif;
    font-size: 14px; font-weight: 800;
    margin-bottom: 8px;
  }
  #info-panel p {
    font-size: 10px; color: var(--text-dim); line-height: 1.7;
  }
  #info-panel .deps-list {
    margin-top: 10px;
    font-size: 9px;
    color: var(--text-dim);
  }
  #info-panel .deps-list span {
    display: inline-block;
    padding: 2px 7px;
    background: var(--border);
    border-radius: 3px;
    margin: 2px 2px 0 0;
  }

  #hint {
    position: fixed;
    bottom: 24px; left: 24px;
    font-size: 10px; color: var(--text-dim);
    line-height: 1.8;
  }
</style>
</head>
<body>

<header>
  <div>
    <span class="logo">Video Downloader <span>‚Äî Architecture Dependency Map</span></span>
  </div>
  <div class="legend">
    <div class="leg-item"><div class="leg-dot" style="color:var(--accent-cyan)"></div> Entry</div>
    <div class="leg-item"><div class="leg-dot" style="color:var(--accent-purple)"></div> UI / XAML</div>
    <div class="leg-item"><div class="leg-dot" style="color:var(--accent-amber)"></div> C# Core</div>
    <div class="leg-item"><div class="leg-dot" style="color:var(--accent-green)"></div> Services</div>
    <div class="leg-item"><div class="leg-dot" style="color:var(--accent-rose)"></div> System</div>
    <div class="leg-item"><div class="leg-dot" style="color:var(--accent-blue)"></div> External</div>
  </div>
  <div class="controls">
    <button class="ctrl-btn" onclick="resetView()">‚Ü∫ Reset</button>
    <button class="ctrl-btn" onclick="zoomIn()">+ Zoom</button>
    <button class="ctrl-btn" onclick="zoomOut()">‚àí Zoom</button>
  </div>
</header>

<div id="canvas-wrap">
  <canvas id="graph-canvas"></canvas>
  <div id="nodes-layer"></div>
</div>

<div id="info-panel">
  <h3 id="ip-title">‚Äî</h3>
  <p id="ip-desc">‚Äî</p>
  <div class="deps-list" id="ip-deps"></div>
</div>

<div id="hint"></div>
<script>
  const isTouchDevice = ('ontouchstart' in window) || navigator.maxTouchPoints > 0;
  document.getElementById('hint').innerHTML = isTouchDevice
    ? 'üëÜ Drag to pan &nbsp;¬∑&nbsp; Pinch to zoom &nbsp;¬∑&nbsp; Tap node for details'
    : 'üñ± Drag to pan &nbsp;¬∑&nbsp; Scroll to zoom &nbsp;¬∑&nbsp; Click node for details';
</script>

<script>
const nodes = [
  // Entry
  { id: 'app_xaml', x: 500, y: 110, layer: 'entry', icon: '‚ö°', title: 'App.xaml', sub: 'WPF Application root\nApp lifecycle & startup', tag: 'C# Entry',
    desc: 'Application entry point. Defines the WPF Application class, sets startup URI to InitWindow, and manages global application lifecycle events (startup, exit, unhandled exceptions).',
    deps: ['app_xaml_cs', 'init_window'] },

  { id: 'app_xaml_cs', x: 500, y: 260, layer: 'core', icon: '‚öôÔ∏è', title: 'App.xaml.cs', sub: 'App bootstrap logic\nGlobal state init', tag: 'C# Backend',
    desc: 'Code-behind for App.xaml. Initializes global application state, wires up unhandled exception handlers, and bootstraps the DataAccessor and preferences system on launch.',
    deps: ['data_accessor', 'preferences'] },

  // UI Layer
  { id: 'init_window', x: 220, y: 260, layer: 'ui', icon: 'üöÄ', title: 'InitWindow.xaml', sub: 'Splash / dependency check\nyt-dlp & ffmpeg verify', tag: 'WPF Window',
    desc: 'Startup splash window. Verifies that yt-dlp.exe and ffmpeg.exe are present in the Dependencies folder. Shows loading status and transitions to MainWindow once ready.',
    deps: ['init_window_cs', 'wpf_core'] },

  { id: 'init_window_cs', x: 80, y: 420, layer: 'core', icon: '‚öôÔ∏è', title: 'InitWindow.xaml.cs', sub: 'Dependency validation\nLaunch handoff', tag: 'C# Backend',
    desc: 'Code-behind for InitWindow. Checks file existence of yt-dlp.exe and ffmpeg.exe, optionally downloads them if missing, then instantiates and shows MainWindow.',
    deps: ['main_window', 'yt_dlp', 'ffmpeg'] },

  { id: 'main_window', x: 500, y: 420, layer: 'ui', icon: 'ü™ü', title: 'MainWindow.xaml', sub: 'Primary UI\nURL input ¬∑ Download btn', tag: 'WPF Window',
    desc: 'Main application window. Contains the URL text field, format selector (video/audio), quality options, download button, progress bar, and status label. The primary user-facing surface.',
    deps: ['main_window_cs', 'wpf_core'] },

  { id: 'main_window_cs', x: 500, y: 580, layer: 'core', icon: '‚öôÔ∏è', title: 'MainWindow.xaml.cs', sub: 'Download orchestration\nProgress tracking', tag: 'C# Backend',
    desc: 'Code-behind for MainWindow. Handles user input, triggers download via YoutubeDLSharp wrapper, wires progress events to the UI progress bar, and manages cancellation tokens.',
    deps: ['data_accessor', 'ytdlsharp', 'profile_window'] },

  { id: 'profile_window', x: 780, y: 420, layer: 'ui', icon: 'üë§', title: 'Profile.xaml', sub: 'User preferences UI\nOutput path ¬∑ format defaults', tag: 'WPF Window',
    desc: 'Profile/settings window. Lets the user configure default download directory, preferred format (MP4/WebM/MP3), video quality, and other persistent preferences.',
    deps: ['profile_window_cs', 'wpf_core'] },

  { id: 'profile_window_cs', x: 780, y: 580, layer: 'core', icon: '‚öôÔ∏è', title: 'Profile.xaml.cs', sub: 'Settings read/write\nPreferences persistence', tag: 'C# Backend',
    desc: 'Code-behind for Profile window. Reads and writes user preferences to preferences.json via DataAccessor. Applies settings changes immediately on save.',
    deps: ['data_accessor', 'preferences'] },

  { id: 'error_window', x: 1000, y: 420, layer: 'ui', icon: 'üî¥', title: 'Error.xaml', sub: 'Error display\nStack trace ¬∑ Dismiss', tag: 'WPF Window',
    desc: 'Error dialog window. Surfaces runtime errors and download failures to the user with a readable message and optional stack trace detail. Supports dismiss and retry actions.',
    deps: ['error_window_cs', 'wpf_core'] },

  { id: 'error_window_cs', x: 1000, y: 580, layer: 'core', icon: '‚öôÔ∏è', title: 'Error.xaml.cs', sub: 'Error context binding\nEvent relay', tag: 'C# Backend',
    desc: 'Code-behind for Error window. Receives error context from MainWindow or DataAccessor and binds it to the XAML view for display.',
    deps: ['data_accessor'] },

  // Core / Service Layer
  { id: 'data_accessor', x: 500, y: 760, layer: 'core', icon: 'üóÑ', title: 'DataAccessor.cs', sub: 'Download API facade\nJSON ¬∑ file I/O', tag: 'C# Core',
    desc: 'Central service class. Wraps YoutubeDLSharp calls, handles format selection, manages output path resolution, reads/writes preferences.json via Newtonsoft.Json, and emits progress events.',
    deps: ['ytdlsharp', 'newtonsoft', 'preferences'] },

  { id: 'preferences', x: 270, y: 760, layer: 'service', icon: 'üìã', title: 'preferences.json', sub: 'Output path ¬∑ quality\nFormat defaults', tag: 'User Data',
    desc: 'Persisted user preferences file stored in the UserPreferences folder alongside the binary. Contains default output directory, preferred format, quality level, and other settings. Serialized/deserialized with Newtonsoft.Json.',
    deps: ['newtonsoft'] },

  // Service Layer
  { id: 'ytdlsharp', x: 500, y: 950, layer: 'service', icon: 'üì°', title: 'YoutubeDLSharp', sub: '.NET wrapper for yt-dlp\nAsync download API', tag: 'NuGet Package',
    desc: 'YoutubeDLSharp.dll ‚Äî a .NET wrapper library for yt-dlp. Provides async download methods, format option structs, progress reporting via IProgress<T>, and process management for the yt-dlp subprocess.',
    deps: ['yt_dlp'] },

  { id: 'newtonsoft', x: 270, y: 950, layer: 'ext', icon: '{}', title: 'Newtonsoft.Json', sub: 'JSON serialization\nPreferences R/W', tag: 'NuGet Package',
    desc: 'Newtonsoft.Json.dll ‚Äî industry-standard JSON library. Used by DataAccessor to serialize and deserialize the preferences.json file and parse any API or metadata responses.',
    deps: [] },

  // External CLI tools
  { id: 'yt_dlp', x: 400, y: 1120, layer: 'ext', icon: '‚ñ∂Ô∏è', title: 'yt-dlp.exe', sub: 'YouTube metadata & stream\nextract + download', tag: 'External Binary',
    desc: 'yt-dlp.exe ‚Äî powerful open-source YouTube download engine. Invoked as a subprocess by YoutubeDLSharp. Handles URL parsing, format selection, stream fetching, and passes raw video/audio data to ffmpeg for muxing.',
    deps: ['ffmpeg'] },

  { id: 'ffmpeg', x: 620, y: 1120, layer: 'ext', icon: 'üéû', title: 'ffmpeg.exe', sub: 'Audio/video muxing\nFormat conversion', tag: 'External Binary',
    desc: 'ffmpeg.exe ‚Äî multimedia processing engine. Used by yt-dlp to merge separate video and audio streams into the final output file and to transcode to requested formats (MP3, MP4, WebM, etc.).',
    deps: [] },

  // System / Build
  { id: 'wpf_core', x: 130, y: 760, layer: 'system', icon: 'üñº', title: 'WPF / .NET 9', sub: 'XAML rendering engine\nData binding ¬∑ controls', tag: '.NET 9 Framework',
    desc: 'Windows Presentation Foundation on .NET 9.0. Provides the XAML parser, dependency property system, data binding, layout engine, and built-in controls (TextBox, Button, ProgressBar, etc.).',
    deps: ['dotnet_runtime'] },

  { id: 'dotnet_runtime', x: 130, y: 950, layer: 'system', icon: 'üî©', title: '.NET Runtime', sub: 'CLR ¬∑ GC ¬∑ P/Invoke\nSelf-contained publish', tag: '.NET 9',
    desc: 'The .NET 9 Common Language Runtime. Provides JIT compilation, garbage collection, async/await infrastructure, and P/Invoke for native interop. Published as self-contained (SelfContained=true) for zero-dependency distribution.',
    deps: [] },

  { id: 'build_tools', x: 870, y: 760, layer: 'system', icon: 'üõ†', title: 'Build & Deploy', sub: 'dotnet publish ¬∑ R2R\nAdvanced Installer', tag: 'Tooling',
    desc: 'Build pipeline using dotnet publish with win-x64/win-x86 targets, ReadyToRun (R2R) compilation for startup perf, single-file packaging, and Advanced Installer for the .exe setup wizard. Git LFS manages binary assets.',
    deps: [] },

  { id: 'assemblyinfo', x: 1000, y: 260, layer: 'system', icon: 'üìÑ', title: 'AssemblyInfo.cs', sub: 'Version ¬∑ metadata\nProduct info', tag: 'Build Artifact',
    desc: 'Assembly metadata file. Defines AssemblyVersion, FileVersion, product name ("Video Downloader"), company, copyright, and GUID. Consumed by the build system and installer.',
    deps: [] },
];

const edges = [
  { from: 'app_xaml',         to: 'app_xaml_cs' },
  { from: 'app_xaml',         to: 'init_window' },
  { from: 'app_xaml_cs',      to: 'data_accessor' },
  { from: 'app_xaml_cs',      to: 'preferences' },
  { from: 'init_window',      to: 'init_window_cs' },
  { from: 'init_window',      to: 'wpf_core' },
  { from: 'init_window_cs',   to: 'main_window' },
  { from: 'init_window_cs',   to: 'yt_dlp' },
  { from: 'init_window_cs',   to: 'ffmpeg' },
  { from: 'main_window',      to: 'main_window_cs' },
  { from: 'main_window',      to: 'wpf_core' },
  { from: 'main_window_cs',   to: 'data_accessor' },
  { from: 'main_window_cs',   to: 'ytdlsharp' },
  { from: 'main_window_cs',   to: 'profile_window' },
  { from: 'profile_window',   to: 'profile_window_cs' },
  { from: 'profile_window',   to: 'wpf_core' },
  { from: 'profile_window_cs',to: 'data_accessor' },
  { from: 'profile_window_cs',to: 'preferences' },
  { from: 'error_window',     to: 'error_window_cs' },
  { from: 'error_window',     to: 'wpf_core' },
  { from: 'error_window_cs',  to: 'data_accessor' },
  { from: 'data_accessor',    to: 'ytdlsharp' },
  { from: 'data_accessor',    to: 'newtonsoft' },
  { from: 'data_accessor',    to: 'preferences' },
  { from: 'preferences',      to: 'newtonsoft' },
  { from: 'ytdlsharp',        to: 'yt_dlp' },
  { from: 'yt_dlp',           to: 'ffmpeg' },
  { from: 'wpf_core',         to: 'dotnet_runtime' },
  { from: 'main_window_cs',   to: 'error_window' },
  { from: 'build_tools',      to: 'dotnet_runtime' },
];

// ‚îÄ‚îÄ‚îÄ Viewport state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Graph spans x: 80‚Äì1000, y: 110‚Äì1120. Center on x‚âà540, y‚âà615.
const GRAPH_CX = 540;
const GRAPH_CY = 615;
let scale = 1;
let offsetX = window.innerWidth  / 2 - GRAPH_CX * scale;
let offsetY = window.innerHeight / 2 - GRAPH_CY * scale;
let isDragging = false, dragStart = {x:0,y:0};
let activeNode = null;

const wrap = document.getElementById('canvas-wrap');
const canvas = document.getElementById('graph-canvas');
const ctx = canvas.getContext('2d');
const nodesLayer = document.getElementById('nodes-layer');
const infoPanel = document.getElementById('info-panel');

const layerColors = {
  entry: '#00e5ff', ui: '#b388ff', core: '#ffb300',
  service: '#00e676', system: '#ff4d6d', ext: '#448aff'
};

// ‚îÄ‚îÄ‚îÄ Build DOM nodes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const nodeMap = {};
nodes.forEach(n => {
  const el = document.createElement('div');
  el.className = `node layer-${n.layer}`;
  el.id = 'n_' + n.id;
  el.style.left = n.x + 'px';
  el.style.top = n.y + 'px';
  el.innerHTML = `
    <div class="node-header">
      <span class="node-icon">${n.icon}</span>
      <span class="node-title">${n.title}</span>
    </div>
    <div class="node-sub">${n.sub}</div>
    <span class="node-tag">${n.tag}</span>
  `;
  el.addEventListener('click', (e) => { e.stopPropagation(); selectNode(n); });
  nodesLayer.appendChild(el);
  nodeMap[n.id] = { data: n, el };
});

// ‚îÄ‚îÄ‚îÄ Canvas resize ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function resizeCanvas() {
  canvas.width = wrap.clientWidth;
  canvas.height = wrap.clientHeight;
  drawEdges();
}
window.addEventListener('resize', resizeCanvas);

function worldToScreen(x, y) {
  return { x: x * scale + offsetX, y: y * scale + offsetY };
}

function getNodeCenter(id) {
  const n = nodeMap[id].data;
  return { x: n.x, y: n.y };
}

function drawEdges() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  edges.forEach(e => {
    const a = getNodeCenter(e.from);
    const b = getNodeCenter(e.to);
    const as = worldToScreen(a.x, a.y);
    const bs = worldToScreen(b.x, b.y);

    const highlight = activeNode && (e.from === activeNode || e.to === activeNode);
    const color = highlight ? layerColors[nodeMap[e.from].data.layer] : '#1e2230';
    const alpha = highlight ? 0.9 : 0.6;

    ctx.beginPath();
    ctx.moveTo(as.x, as.y);
    const cpY = (as.y + bs.y) / 2;
    ctx.bezierCurveTo(as.x, cpY, bs.x, cpY, bs.x, bs.y);
    ctx.strokeStyle = color;
    ctx.globalAlpha = alpha;
    ctx.lineWidth = highlight ? 2 : 1;
    ctx.stroke();
    ctx.globalAlpha = 1;

    const angle = Math.atan2(bs.y - cpY, bs.x - bs.x) + Math.PI / 2;
    const aSize = highlight ? 6 : 4;
    ctx.beginPath();
    ctx.moveTo(bs.x, bs.y);
    ctx.lineTo(bs.x - aSize * Math.cos(angle - Math.PI/6), bs.y - aSize * Math.sin(angle - Math.PI/6));
    ctx.lineTo(bs.x - aSize * Math.cos(angle + Math.PI/6), bs.y - aSize * Math.sin(angle + Math.PI/6));
    ctx.closePath();
    ctx.fillStyle = color;
    ctx.globalAlpha = alpha;
    ctx.fill();
    ctx.globalAlpha = 1;
  });
}

function applyTransform() {
  nodesLayer.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
  drawEdges();
}

wrap.addEventListener('mousedown', e => {
  isDragging = true;
  dragStart = { x: e.clientX - offsetX, y: e.clientY - offsetY };
  wrap.style.cursor = 'grabbing';
});
window.addEventListener('mousemove', e => {
  if (!isDragging) return;
  offsetX = e.clientX - dragStart.x;
  offsetY = e.clientY - dragStart.y;
  applyTransform();
});
window.addEventListener('mouseup', () => {
  isDragging = false;
  wrap.style.cursor = 'grab';
});

let lastTouchDist = null;
wrap.addEventListener('touchstart', e => {
  e.preventDefault();
  if (e.touches.length === 1) {
    isDragging = true;
    dragStart = { x: e.touches[0].clientX - offsetX, y: e.touches[0].clientY - offsetY };
  } else if (e.touches.length === 2) {
    lastTouchDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
  }
}, { passive: false });

wrap.addEventListener('touchmove', e => {
  e.preventDefault();
  if (e.touches.length === 1 && isDragging) {
    offsetX = e.touches[0].clientX - dragStart.x;
    offsetY = e.touches[0].clientY - dragStart.y;
    applyTransform();
  } else if (e.touches.length === 2) {
    const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
    if (lastTouchDist) {
      const factor = dist / lastTouchDist;
      const mx = (e.touches[0].clientX + e.touches[1].clientX) / 2;
      const my = (e.touches[0].clientY + e.touches[1].clientY) / 2;
      offsetX = mx + (offsetX - mx) * factor;
      offsetY = my + (offsetY - my) * factor;
      scale = Math.max(0.2, Math.min(2.5, scale * factor));
      applyTransform();
    }
    lastTouchDist = dist;
  }
}, { passive: false });

wrap.addEventListener('touchend', () => { isDragging = false; lastTouchDist = null; });

wrap.addEventListener('wheel', e => {
  e.preventDefault();
  const factor = e.deltaY > 0 ? 0.92 : 1.08;
  const rect = wrap.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;
  offsetX = mx + (offsetX - mx) * factor;
  offsetY = my + (offsetY - my) * factor;
  scale = Math.max(0.2, Math.min(2.5, scale * factor));
  applyTransform();
}, { passive: false });

function zoomIn()  { scale = Math.min(scale * 1.15, 2.5); applyTransform(); }
function zoomOut() { scale = Math.max(scale * 0.85, 0.2); applyTransform(); }
function resetView() {
  scale = 1;
  offsetX = window.innerWidth  / 2 - GRAPH_CX * scale;
  offsetY = window.innerHeight / 2 - GRAPH_CY * scale;
  applyTransform();
  deselectNode();
}

function selectNode(n) {
  if (activeNode) document.getElementById('n_' + activeNode)?.classList.remove('active');
  activeNode = n.id;
  document.getElementById('n_' + n.id)?.classList.add('active');

  document.getElementById('ip-title').textContent = n.title;
  document.getElementById('ip-title').style.color = layerColors[n.layer];
  document.getElementById('ip-desc').textContent = n.desc;

  const depLabels = (n.deps || []).map(d => {
    const found = nodes.find(x => x.id === d);
    return found ? `<span>${found.title}</span>` : '';
  }).join('');
  document.getElementById('ip-deps').innerHTML = depLabels
    ? `<div style="margin-bottom:5px;color:#5a6480">Depends on:</div>${depLabels}`
    : '';

  infoPanel.classList.add('visible');
  drawEdges();
}

function deselectNode() {
  if (activeNode) document.getElementById('n_' + activeNode)?.classList.remove('active');
  activeNode = null;
  infoPanel.classList.remove('visible');
  drawEdges();
}

wrap.addEventListener('click', deselectNode);

resizeCanvas();
applyTransform();
</script>
</body>
</html>
