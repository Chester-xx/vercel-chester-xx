<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Matrix Calculator â€” Dependency Map</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600;700&family=Syne:wght@400;700;800&display=swap');

  :root {
    --bg: #0a0c10;
    --surface: #111318;
    --border: #1e2230;
    --accent-cyan: #00e5ff;
    --accent-amber: #ffb300;
    --accent-rose: #ff4d6d;
    --accent-green: #00e676;
    --accent-purple: #b388ff;
    --accent-blue: #448aff;
    --text: #e0e6f0;
    --text-dim: #5a6480;
    --node-bg: #151822;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'JetBrains Mono', monospace;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    overflow: hidden;
    user-select: none;
  }

  header {
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 24px;
    background: rgba(10,12,16,0.92);
    border-bottom: 1px solid var(--border);
    backdrop-filter: blur(12px);
  }

  .logo {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 16px;
    letter-spacing: 0.05em;
    color: var(--accent-green);
  }
  .logo span { color: var(--text-dim); font-weight: 400; font-size: 13px; margin-left: 10px; }

  .legend { display: flex; gap: 16px; align-items: center; }
  .leg-item { display: flex; align-items: center; gap: 6px; font-size: 10px; color: var(--text-dim); }
  .leg-dot { width: 10px; height: 10px; border-radius: 50%; border: 2px solid currentColor; }

  .controls { display: flex; gap: 8px; }
  .ctrl-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text-dim);
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    padding: 5px 12px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .ctrl-btn:hover { border-color: var(--accent-green); color: var(--accent-green); }

  #canvas-wrap {
    position: absolute;
    inset: 0; top: 49px;
    overflow: hidden;
    cursor: grab;
  }
  #canvas-wrap:active { cursor: grabbing; }

  #graph-canvas { position: absolute; top: 0; left: 0; pointer-events: none; }
  #nodes-layer  { position: absolute; top: 0; left: 0; transform-origin: 0 0; }

  .node {
    position: absolute;
    background: var(--node-bg);
    border-radius: 8px;
    padding: 12px 16px;
    cursor: pointer;
    transition: transform 0.15s, box-shadow 0.15s;
    min-width: 160px;
    transform: translate(-50%, -50%);
  }
  .node:hover  { transform: translate(-50%, -50%) scale(1.04); }
  .node.active { transform: translate(-50%, -50%) scale(1.06); }

  .node-header { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
  .node-icon   { font-size: 14px; line-height: 1; }
  .node-title  { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 12px; letter-spacing: 0.03em; }
  .node-sub    { font-size: 9px; color: var(--text-dim); line-height: 1.5; margin-top: 2px; }
  .node-tag    { display: inline-block; font-size: 8px; padding: 2px 6px; border-radius: 3px; margin-top: 6px; font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase; }

  .layer-entry   { border: 1.5px solid var(--accent-cyan);   box-shadow: 0 0 18px rgba(0,229,255,0.10); }
  .layer-entry   .node-title { color: var(--accent-cyan); }
  .layer-entry   .node-tag   { background: rgba(0,229,255,0.12); color: var(--accent-cyan); }

  .layer-ui      { border: 1.5px solid var(--accent-purple); box-shadow: 0 0 18px rgba(179,136,255,0.10); }
  .layer-ui      .node-title { color: var(--accent-purple); }
  .layer-ui      .node-tag   { background: rgba(179,136,255,0.12); color: var(--accent-purple); }

  .layer-core    { border: 1.5px solid var(--accent-amber);  box-shadow: 0 0 18px rgba(255,179,0,0.10); }
  .layer-core    .node-title { color: var(--accent-amber); }
  .layer-core    .node-tag   { background: rgba(255,179,0,0.12); color: var(--accent-amber); }

  .layer-runtime { border: 1.5px solid var(--accent-green);  box-shadow: 0 0 18px rgba(0,230,118,0.10); }
  .layer-runtime .node-title { color: var(--accent-green); }
  .layer-runtime .node-tag   { background: rgba(0,230,118,0.12); color: var(--accent-green); }

  .layer-system  { border: 1.5px solid var(--accent-rose);   box-shadow: 0 0 18px rgba(255,77,109,0.10); }
  .layer-system  .node-title { color: var(--accent-rose); }
  .layer-system  .node-tag   { background: rgba(255,77,109,0.12); color: var(--accent-rose); }

  .layer-ext     { border: 1.5px solid var(--accent-blue);   box-shadow: 0 0 18px rgba(68,138,255,0.10); }
  .layer-ext     .node-title { color: var(--accent-blue); }
  .layer-ext     .node-tag   { background: rgba(68,138,255,0.12); color: var(--accent-blue); }

  /* Dashed border for the compile path nodes */
  .compile-path  { border-style: dashed !important; }

  #info-panel {
    position: fixed;
    bottom: 24px; right: 24px;
    width: 290px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 18px;
    transition: opacity 0.2s, transform 0.2s;
    z-index: 200;
    opacity: 0; transform: translateY(8px); pointer-events: none;
  }
  #info-panel.visible { opacity: 1; transform: translateY(0); pointer-events: all; }
  #info-panel h3 { font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 800; margin-bottom: 8px; }
  #info-panel p  { font-size: 10px; color: var(--text-dim); line-height: 1.7; }
  #info-panel .deps-list { margin-top: 10px; font-size: 9px; color: var(--text-dim); }
  #info-panel .deps-list span { display: inline-block; padding: 2px 7px; background: var(--border); border-radius: 3px; margin: 2px 2px 0 0; }

  /* Path labels on canvas */
  .path-label {
    position: absolute;
    font-size: 9px;
    font-family: 'JetBrains Mono', monospace;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    pointer-events: none;
  }

  #hint { position: fixed; bottom: 24px; left: 24px; font-size: 10px; color: var(--text-dim); line-height: 1.8; }
</style>
</head>
<body>

<header>
  <div>
    <span class="logo">Matrix Calculator <span>â€” Architecture Dependency Map</span></span>
  </div>
  <div class="legend">
    <div class="leg-item"><div class="leg-dot" style="color:var(--accent-cyan)"></div> Entry</div>
    <div class="leg-item"><div class="leg-dot" style="color:var(--accent-purple)"></div> UI Layer</div>
    <div class="leg-item"><div class="leg-dot" style="color:var(--accent-amber)"></div> Logic Core</div>
    <div class="leg-item"><div class="leg-dot" style="color:var(--accent-green)"></div> Python Runtime</div>
    <div class="leg-item"><div class="leg-dot" style="color:var(--accent-rose)"></div> Compile Path</div>
    <div class="leg-item"><div class="leg-dot" style="color:var(--accent-blue)"></div> External Libs</div>
  </div>
  <div class="controls">
    <button class="ctrl-btn" onclick="resetView()">â†º Reset</button>
    <button class="ctrl-btn" onclick="zoomIn()">+ Zoom</button>
    <button class="ctrl-btn" onclick="zoomOut()">âˆ’ Zoom</button>
  </div>
</header>

<div id="canvas-wrap">
  <canvas id="graph-canvas"></canvas>
  <div id="nodes-layer"></div>
</div>

<div id="info-panel">
  <h3 id="ip-title">â€”</h3>
  <p id="ip-desc">â€”</p>
  <div class="deps-list" id="ip-deps"></div>
</div>

<div id="hint"></div>

<script>
const nodes = [

  // â”€â”€ Entry / Perception Layer â”€â”€
  { id: 'gui_py', x: 500, y: 100, layer: 'entry', icon: 'âš¡', title: 'GUI.py',
    sub: 'Application entry point\nLaunches CustomTkinter window', tag: 'Entry / Perception',
    desc: 'Primary entry point. Instantiates the CustomTkinter App class, defines all window widgets (grid entry fields, operation buttons, output box, clear button), and wires every button to an event handler. Imports Main.py for all computation. Run via `python GUI.py` or from an IDE.',
    deps: ['main_py', 'customtkinter', 'ctkmessagebox', 'python_runtime'] },

  // â”€â”€ UI Layer â”€â”€
  { id: 'input_grid', x: 200, y: 280, layer: 'ui', icon: 'ðŸ”¢', title: 'Input Grid',
    sub: '3Ã—3 entry widgets (Ã—2)\nMatrix A & Matrix B', tag: 'UI Component',
    desc: 'Two sets of 9 CTkEntry widgets forming the 3Ã—3 input grids for Matrix A and Matrix B. Accepts integer and floating-point values. Event-driven â€” values are read on button press, not continuously polled.',
    deps: ['customtkinter'] },

  { id: 'op_buttons', x: 500, y: 280, layer: 'ui', icon: 'ðŸŽ›', title: 'Operation Buttons',
    sub: 'Add Â· Sub Â· Mul Â· Det\nPower Â· Clear', tag: 'UI Component',
    desc: 'CTkButton instances for each supported operation: Addition, Subtraction, Multiplication, Determinant, Power. Each button is bound to a handler in GUI.py that reads inputs, calls the appropriate Main.py function, and writes the result to the output widget. Clear resets all entries to 0.',
    deps: ['customtkinter', 'ctkmessagebox'] },

  { id: 'output_box', x: 800, y: 280, layer: 'ui', icon: 'ðŸ“¤', title: 'Output Display',
    sub: 'CTkEntry result display\nFormatted matrix output', tag: 'UI Component',
    desc: 'A read-only CTkEntry (or label) widget that receives the formatted result string from GUI.py after computation. Displays the output matrix or scalar. A decimal formatter to 2 d.p. exists in code but is commented out to avoid obfuscating precise results.',
    deps: ['customtkinter'] },

  // â”€â”€ Planning / Logic Core â”€â”€
  { id: 'main_py', x: 500, y: 470, layer: 'core', icon: 'ðŸ§®', title: 'Main.py',
    sub: 'All matrix operations\nZero external math libs', tag: 'Logic Core / Planning',
    desc: 'Pure Python computation module â€” the "planning" layer. Implements all matrix operations from scratch with no external math libraries (no NumPy). Contains: add(), subtract(), multiply(), determinant() via cofactor expansion, power() via repeated multiplication. Receives parsed float inputs from GUI.py and returns result matrices or scalars.',
    deps: ['python_runtime'] },

  { id: 'op_add_sub', x: 200, y: 640, layer: 'core', icon: 'âž•', title: 'Add / Subtract',
    sub: 'Element-wise ops\nMatrix A Â± Matrix B', tag: 'Matrix Op',
    desc: 'Element-wise addition and subtraction of two 3Ã—3 matrices. Iterates rows and columns, summing or differencing corresponding elements. Returns a 3Ã—3 result matrix.',
    deps: [] },

  { id: 'op_mul', x: 420, y: 640, layer: 'core', icon: 'âœ–ï¸', title: 'Multiply',
    sub: 'Dot product\nRow Ã— Column accumulation', tag: 'Matrix Op',
    desc: 'Standard matrix multiplication via triple-nested loop (row i Ã— col j dot product). Operates on 3Ã—3 inputs, returns a 3Ã—3 result. No broadcasting or shortcut algorithms â€” straightforward O(nÂ³) implementation.',
    deps: [] },

  { id: 'op_det', x: 620, y: 640, layer: 'core', icon: 'ðŸ”µ', title: 'Determinant',
    sub: 'Cofactor expansion\nRecursive 3Ã—3 formula', tag: 'Matrix Op',
    desc: 'Calculates the scalar determinant of a 3Ã—3 matrix using cofactor (Laplace) expansion along the first row. Returns a single float value. Used independently and internally for potential future inverse support.',
    deps: [] },

  { id: 'op_power', x: 820, y: 640, layer: 'core', icon: 'ðŸ”º', title: 'Power',
    sub: 'Matrix ^ n\nRepeated multiplication', tag: 'Matrix Op',
    desc: 'Raises a 3Ã—3 matrix to an integer power n by performing repeated matrix multiplication (nâˆ’1 times). Power of 0 returns the identity matrix. Relies on the multiply() function internally.',
    deps: ['op_mul'] },

  { id: 'test_py', x: 1050, y: 470, layer: 'core', icon: 'ðŸ§ª', title: 'Test.py',
    sub: 'Dev scratch file\nNew code staging', tag: 'Dev Utility',
    desc: 'Standalone developer scratch file used to prototype and test new logic before integrating into Main.py or GUI.py. Has no connection to the running application and is not imported by any module. Included in the repo for transparency.',
    deps: ['python_runtime'] },

  // â”€â”€ Python Runtime â”€â”€
  { id: 'python_runtime', x: 500, y: 840, layer: 'runtime', icon: 'ðŸ', title: 'Python Interpreter',
    sub: 'CPython runtime\nBytecode compile â†’ execute', tag: 'Python Runtime',
    desc: 'The CPython interpreter (e.g. from Microsoft Store or python.org). Parses and compiles GUI.py and Main.py to bytecode (.pyc), then executes via the Python Virtual Machine (PVM). Manages memory, the import system, and the event loop that drives the Tkinter/CustomTkinter UI.',
    deps: ['pvm', 'stdlib_tkinter'] },

  { id: 'pvm', x: 280, y: 1010, layer: 'runtime', icon: 'âš™ï¸', title: 'Python VM',
    sub: 'Bytecode execution\nGIL Â· memory Â· imports', tag: 'CPython PVM',
    desc: 'The CPython Virtual Machine executes compiled .pyc bytecode. Manages the Global Interpreter Lock (GIL), reference counting garbage collection, module import resolution, and the call stack. All Python logic in Main.py runs through the PVM.',
    deps: [] },

  { id: 'stdlib_tkinter', x: 720, y: 1010, layer: 'runtime', icon: 'ðŸ–¼', title: 'tkinter (stdlib)',
    sub: 'Tcl/Tk bridge\nWidget event loop', tag: 'Python Stdlib',
    desc: 'Python\'s built-in Tkinter module, part of the standard library. Wraps the Tcl/Tk GUI toolkit via C extension (_tkinter). CustomTkinter builds on top of Tkinter, theming its widgets. The Tkinter mainloop() drives the entire UI event system.',
    deps: [] },

  // â”€â”€ External Libraries â”€â”€
  { id: 'customtkinter', x: 200, y: 470, layer: 'ext', icon: 'ðŸŽ¨', title: 'CustomTkinter',
    sub: 'Modern themed widgets\npip install customtkinter', tag: 'pip Package',
    desc: 'CustomTkinter (pip install customtkinter) â€” a modern, themeable UI library that wraps and extends Tkinter widgets. Provides CTkFrame, CTkEntry, CTkButton, CTkLabel with dark/light mode support and rounded styling. The entire GUI is built using CTk components.',
    deps: ['stdlib_tkinter'] },

  { id: 'ctkmessagebox', x: 800, y: 470, layer: 'ext', icon: 'ðŸ’¬', title: 'CTkMessagebox',
    sub: 'Styled dialog popups\npip install CTkMessagebox', tag: 'pip Package',
    desc: 'CTkMessagebox (pip install CTkMessagebox) â€” a CustomTkinter-compatible message dialog library. Used in GUI.py to display error messages (e.g. invalid input, non-square power operations) as styled popup dialogs rather than raw Tkinter messageboxes.',
    deps: ['customtkinter'] },

  // â”€â”€ Compile Path (dashed â€” alternate execution route) â”€â”€
  { id: 'auto_py_to_exe', x: 1150, y: 280, layer: 'system', icon: 'ðŸ”§', title: 'auto-py-to-exe',
    sub: 'PyInstaller GUI wrapper\nOne-folder / one-file build', tag: 'Build Tool',
    extra_class: 'compile-path',
    desc: 'auto-py-to-exe â€” a GUI front-end for PyInstaller. Lets the developer configure bundling options (one-file vs one-folder, windowed mode, icon) and runs PyInstaller underneath. Used to produce MatrixCalculator.exe from GUI.py and Main.py.',
    deps: ['pyinstaller'] },

  { id: 'pyinstaller', x: 1150, y: 470, layer: 'system', icon: 'ðŸ“¦', title: 'PyInstaller',
    sub: 'Bundle Python + deps\ninto standalone binary', tag: 'Compiler',
    extra_class: 'compile-path',
    desc: 'PyInstaller analyses the import graph of GUI.py, collects all required modules (Main.py, CustomTkinter, CTkMessagebox, tkinter, CPython stdlib), and bundles them alongside a bootloader into a self-contained .exe. The bootloader extracts and runs the embedded Python interpreter at launch.',
    deps: ['bootloader', 'python_runtime', 'customtkinter', 'ctkmessagebox'] },

  { id: 'bootloader', x: 1150, y: 640, layer: 'system', icon: 'ðŸš€', title: 'PyInstaller Bootloader',
    sub: 'Embedded interpreter\nExtract â†’ exec at runtime', tag: 'Bundled Runtime',
    extra_class: 'compile-path',
    desc: 'A small C binary compiled into the .exe by PyInstaller. At launch it extracts the bundled Python interpreter and all dependencies into a temp directory (_MEIPASS), then hands off execution to GUI.py. This is what makes the .exe self-contained with zero install requirements.',
    deps: [] },

  { id: 'exe', x: 1150, y: 840, layer: 'system', icon: 'ðŸ’¾', title: 'MatrixCalculator.exe',
    sub: 'Standalone Windows binary\nNo Python install needed', tag: 'Output Binary',
    extra_class: 'compile-path',
    desc: 'The final packaged Windows executable produced by PyInstaller via auto-py-to-exe. Contains the bundled CPython interpreter, GUI.py, Main.py, CustomTkinter, CTkMessagebox, and all tkinter dependencies. Runs as a normal .exe â€” no Python installation required on the target machine.',
    deps: ['bootloader'] },

];

const edges = [
  // Entry â†’ UI
  { from: 'gui_py',          to: 'input_grid',      type: 'normal' },
  { from: 'gui_py',          to: 'op_buttons',      type: 'normal' },
  { from: 'gui_py',          to: 'output_box',      type: 'normal' },
  // Entry â†’ Logic
  { from: 'gui_py',          to: 'main_py',         type: 'normal' },
  // Entry â†’ Libs
  { from: 'gui_py',          to: 'customtkinter',   type: 'normal' },
  { from: 'gui_py',          to: 'ctkmessagebox',   type: 'normal' },
  // Entry â†’ Runtime
  { from: 'gui_py',          to: 'python_runtime',  type: 'normal' },
  // UI â†’ Libs
  { from: 'input_grid',      to: 'customtkinter',   type: 'normal' },
  { from: 'op_buttons',      to: 'customtkinter',   type: 'normal' },
  { from: 'op_buttons',      to: 'ctkmessagebox',   type: 'normal' },
  { from: 'output_box',      to: 'customtkinter',   type: 'normal' },
  // Logic core
  { from: 'main_py',         to: 'op_add_sub',      type: 'normal' },
  { from: 'main_py',         to: 'op_mul',          type: 'normal' },
  { from: 'main_py',         to: 'op_det',          type: 'normal' },
  { from: 'main_py',         to: 'op_power',        type: 'normal' },
  { from: 'main_py',         to: 'python_runtime',  type: 'normal' },
  { from: 'op_power',        to: 'op_mul',          type: 'normal' },
  // Libs â†’ Runtime
  { from: 'customtkinter',   to: 'stdlib_tkinter',  type: 'normal' },
  { from: 'ctkmessagebox',   to: 'customtkinter',   type: 'normal' },
  // Runtime internals
  { from: 'python_runtime',  to: 'pvm',             type: 'normal' },
  { from: 'python_runtime',  to: 'stdlib_tkinter',  type: 'normal' },
  // Test
  { from: 'test_py',         to: 'python_runtime',  type: 'normal' },
  // Compile path (dashed)
  { from: 'auto_py_to_exe',  to: 'pyinstaller',     type: 'compile' },
  { from: 'pyinstaller',     to: 'python_runtime',  type: 'compile' },
  { from: 'pyinstaller',     to: 'customtkinter',   type: 'compile' },
  { from: 'pyinstaller',     to: 'ctkmessagebox',   type: 'compile' },
  { from: 'pyinstaller',     to: 'bootloader',      type: 'compile' },
  { from: 'bootloader',      to: 'exe',             type: 'compile' },
  { from: 'gui_py',          to: 'auto_py_to_exe',  type: 'compile' },
];

// â”€â”€â”€ Viewport â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Graph spans x: 200â€“1150, y: 100â€“1010. Centre â‰ˆ (675, 555)
const GRAPH_CX = 675;
const GRAPH_CY = 555;
let scale = 1;
let offsetX = window.innerWidth  / 2 - GRAPH_CX;
let offsetY = window.innerHeight / 2 - GRAPH_CY;
let isDragging = false, dragStart = { x: 0, y: 0 };
let activeNode = null;

const wrap      = document.getElementById('canvas-wrap');
const canvas    = document.getElementById('graph-canvas');
const ctx       = canvas.getContext('2d');
const nodesLayer = document.getElementById('nodes-layer');
const infoPanel = document.getElementById('info-panel');

const layerColors = {
  entry: '#00e5ff', ui: '#b388ff', core: '#ffb300',
  runtime: '#00e676', system: '#ff4d6d', ext: '#448aff'
};

// â”€â”€â”€ Build nodes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const nodeMap = {};
nodes.forEach(n => {
  const el = document.createElement('div');
  el.className = `node layer-${n.layer}${n.extra_class ? ' ' + n.extra_class : ''}`;
  el.id = 'n_' + n.id;
  el.style.left = n.x + 'px';
  el.style.top  = n.y + 'px';
  el.innerHTML = `
    <div class="node-header">
      <span class="node-icon">${n.icon}</span>
      <span class="node-title">${n.title}</span>
    </div>
    <div class="node-sub">${n.sub}</div>
    <span class="node-tag">${n.tag}</span>
  `;
  el.addEventListener('click', e => { e.stopPropagation(); selectNode(n); });
  nodesLayer.appendChild(el);
  nodeMap[n.id] = { data: n, el };
});

// â”€â”€â”€ Canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resizeCanvas() {
  canvas.width  = wrap.clientWidth;
  canvas.height = wrap.clientHeight;
  drawEdges();
}
window.addEventListener('resize', resizeCanvas);

function worldToScreen(x, y) {
  return { x: x * scale + offsetX, y: y * scale + offsetY };
}

function drawEdges() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  edges.forEach(e => {
    const a  = nodeMap[e.from].data;
    const b  = nodeMap[e.to].data;
    const as = worldToScreen(a.x, a.y);
    const bs = worldToScreen(b.x, b.y);

    const isCompile  = e.type === 'compile';
    const highlight  = activeNode && (e.from === activeNode || e.to === activeNode);
    const baseColor  = isCompile ? '#ff4d6d' : '#1e2230';
    const hiColor    = layerColors[nodeMap[e.from].data.layer];
    const color      = highlight ? hiColor : baseColor;
    const alpha      = highlight ? 0.9 : (isCompile ? 0.5 : 0.6);
    const lineWidth  = highlight ? 2 : (isCompile ? 1.5 : 1);

    ctx.save();
    if (isCompile) ctx.setLineDash([5, 4]);
    ctx.beginPath();
    ctx.moveTo(as.x, as.y);
    const cpY = (as.y + bs.y) / 2;
    ctx.bezierCurveTo(as.x, cpY, bs.x, cpY, bs.x, bs.y);
    ctx.strokeStyle = color;
    ctx.globalAlpha = alpha;
    ctx.lineWidth   = lineWidth;
    ctx.stroke();
    ctx.setLineDash([]);

    // Arrow
    const angle = Math.atan2(bs.y - cpY, 0) + Math.PI / 2;
    const aSize = highlight ? 6 : 4;
    ctx.beginPath();
    ctx.moveTo(bs.x, bs.y);
    ctx.lineTo(bs.x - aSize * Math.cos(angle - Math.PI/6), bs.y - aSize * Math.sin(angle - Math.PI/6));
    ctx.lineTo(bs.x - aSize * Math.cos(angle + Math.PI/6), bs.y - aSize * Math.sin(angle + Math.PI/6));
    ctx.closePath();
    ctx.fillStyle   = color;
    ctx.fill();
    ctx.restore();
    ctx.globalAlpha = 1;
  });

  // Path labels
  ctx.save();
  ctx.font      = `600 9px 'JetBrains Mono', monospace`;
  ctx.textAlign = 'center';

  const interp = worldToScreen(500, 470);
  ctx.fillStyle   = 'rgba(0,230,118,0.45)';
  ctx.fillText('â† INTERPRETER PATH', interp.x - 130 * scale, interp.y - 18 * scale);

  const compile = worldToScreen(1150, 185);
  ctx.fillStyle   = 'rgba(255,77,109,0.45)';
  ctx.fillText('COMPILE PATH â†’', compile.x, compile.y);

  ctx.restore();
}

function applyTransform() {
  nodesLayer.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
  drawEdges();
}

// â”€â”€â”€ Pan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
wrap.addEventListener('mousedown', e => {
  isDragging = true;
  dragStart  = { x: e.clientX - offsetX, y: e.clientY - offsetY };
  wrap.style.cursor = 'grabbing';
});
window.addEventListener('mousemove', e => {
  if (!isDragging) return;
  offsetX = e.clientX - dragStart.x;
  offsetY = e.clientY - dragStart.y;
  applyTransform();
});
window.addEventListener('mouseup', () => {
  isDragging = false;
  wrap.style.cursor = 'grab';
});

// â”€â”€â”€ Touch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lastTouchDist = null;
wrap.addEventListener('touchstart', e => {
  e.preventDefault();
  if (e.touches.length === 1) {
    isDragging = true;
    dragStart  = { x: e.touches[0].clientX - offsetX, y: e.touches[0].clientY - offsetY };
  } else if (e.touches.length === 2) {
    lastTouchDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
  }
}, { passive: false });

wrap.addEventListener('touchmove', e => {
  e.preventDefault();
  if (e.touches.length === 1 && isDragging) {
    offsetX = e.touches[0].clientX - dragStart.x;
    offsetY = e.touches[0].clientY - dragStart.y;
    applyTransform();
  } else if (e.touches.length === 2) {
    const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
    if (lastTouchDist) {
      const factor = dist / lastTouchDist;
      const mx = (e.touches[0].clientX + e.touches[1].clientX) / 2;
      const my = (e.touches[0].clientY + e.touches[1].clientY) / 2;
      offsetX = mx + (offsetX - mx) * factor;
      offsetY = my + (offsetY - my) * factor;
      scale = Math.max(0.2, Math.min(2.5, scale * factor));
      applyTransform();
    }
    lastTouchDist = dist;
  }
}, { passive: false });
wrap.addEventListener('touchend', () => { isDragging = false; lastTouchDist = null; });

// â”€â”€â”€ Zoom â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
wrap.addEventListener('wheel', e => {
  e.preventDefault();
  const factor = e.deltaY > 0 ? 0.92 : 1.08;
  const rect   = wrap.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;
  offsetX = mx + (offsetX - mx) * factor;
  offsetY = my + (offsetY - my) * factor;
  scale   = Math.max(0.2, Math.min(2.5, scale * factor));
  applyTransform();
}, { passive: false });

function zoomIn()  { scale = Math.min(scale * 1.15, 2.5); applyTransform(); }
function zoomOut() { scale = Math.max(scale * 0.85, 0.2); applyTransform(); }
function resetView() {
  scale   = 1;
  offsetX = window.innerWidth  / 2 - GRAPH_CX;
  offsetY = window.innerHeight / 2 - GRAPH_CY;
  applyTransform();
  deselectNode();
}

// â”€â”€â”€ Selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectNode(n) {
  if (activeNode) document.getElementById('n_' + activeNode)?.classList.remove('active');
  activeNode = n.id;
  document.getElementById('n_' + n.id)?.classList.add('active');
  document.getElementById('ip-title').textContent = n.title;
  document.getElementById('ip-title').style.color = layerColors[n.layer];
  document.getElementById('ip-desc').textContent  = n.desc;
  const depLabels = (n.deps || []).map(d => {
    const found = nodes.find(x => x.id === d);
    return found ? `<span>${found.title}</span>` : '';
  }).join('');
  document.getElementById('ip-deps').innerHTML = depLabels
    ? `<div style="margin-bottom:5px;color:#5a6480">Depends on:</div>${depLabels}` : '';
  infoPanel.classList.add('visible');
  drawEdges();
}

function deselectNode() {
  if (activeNode) document.getElementById('n_' + activeNode)?.classList.remove('active');
  activeNode = null;
  infoPanel.classList.remove('visible');
  drawEdges();
}

wrap.addEventListener('click', deselectNode);

// â”€â”€â”€ Hint â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const isTouchDevice = ('ontouchstart' in window) || navigator.maxTouchPoints > 0;
document.getElementById('hint').innerHTML = isTouchDevice
  ? 'ðŸ‘† Drag to pan &nbsp;Â·&nbsp; Pinch to zoom &nbsp;Â·&nbsp; Tap node for details'
  : 'ðŸ–± Drag to pan &nbsp;Â·&nbsp; Scroll to zoom &nbsp;Â·&nbsp; Click node for details';

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
resizeCanvas();
applyTransform();
</script>
</body>
</html>